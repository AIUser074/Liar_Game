<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¼ì´ì–´ ê²Œì„</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #5c6bc0;
        }
        .game-section {
            margin-bottom: 20px;
        }
        .player {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #e8eaf6;
        }
        .player.you {
            background-color: #c5cae9;
            border-left: 4px solid #3f51b5;
        }
        .player.liar {
            border-left: 4px solid #f44336;
        }
        .input-area {
            margin: 20px 0;
        }
        input[type="text"] {
            width: 70%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background-color: #5c6bc0;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
        }
        button:hover {
            background-color: #3f51b5;
        }
        .disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
        }
        .disabled:hover {
            background-color: #bdbdbd;
        }
        .hidden {
            display: none;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            background-color: #e3f2fd;
            border-radius: 4px;
        }
        .vote-area {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .vote-player {
            text-align: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
        }
        .vote-player:hover {
            background-color: #e8eaf6;
        }
        .vote-player.selected {
            background-color: #c5cae9;
            border: 2px solid #3f51b5;
        }
        .topic-info {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 5px;
            border-left: 4px solid #4caf50;
        }
        .final-result {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1.2em;
        }
        .win {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .lose {
            background-color: #ffebee;
            color: #c62828;
        }
        .rules {
            background-color: #fff8e1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .statement {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ë¼ì´ì–´ ê²Œì„</h1>
        
        <div class="rules">
            <p><strong>ê²Œì„ ê·œì¹™:</strong></p>
            <ol>
                <li>ë¼ì´ì–´ í•œ ëª…, ì‹œë¯¼ ì„¸ ëª…ìœ¼ë¡œ ê²Œì„ì´ ì§„í–‰ë©ë‹ˆë‹¤.</li>
                <li>ë¼ì´ì–´ëŠ” ì£¼ì œì˜ ì¹´í…Œê³ ë¦¬ë§Œ ì•Œê³ , ì‹œë¯¼ì€ ì •í™•í•œ ì£¼ì œì–´ë¥¼ ì•Œê²Œ ë©ë‹ˆë‹¤.</li>
                <li>ëª¨ë“  í”Œë ˆì´ì–´ëŠ” ìˆœì„œëŒ€ë¡œ ì£¼ì œì–´ì— ëŒ€í•œ í•œë§ˆë””ë¥¼ ë‚¨ê¹ë‹ˆë‹¤. (30ì ì œí•œ)</li>
                <li>ëª¨ë“  ë°œì–¸ì„ ë“£ê³  ë‚œ í›„ ë¼ì´ì–´ê°€ ëˆ„êµ¬ì¸ì§€ í† ë¡ í•©ë‹ˆë‹¤.</li>
                <li>ë¼ì´ì–´ë¡œ ì˜ì‹¬ë˜ëŠ” ì‚¬ëŒì—ê²Œ íˆ¬í‘œí•©ë‹ˆë‹¤.</li>
                <li>ê°€ì¥ ë§ì€ í‘œë¥¼ ë°›ì€ ì‚¬ëŒì´ ë¼ì´ì–´ì¸ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ ìµœì¢… íˆ¬í‘œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</li>
                <li>ìµœì¢… íˆ¬í‘œ í•©ê²© ì‹œ, ë¼ì´ì–´ëŠ” ì£¼ì œì–´ë¥¼ ë§í˜€ì•¼ ìŠ¹ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            </ol>
        </div>
        
        <div id="start-section" class="game-section">
        
            <div id="ranking-ui" style="text-align: center; margin-bottom: 20px;">
              <p id="streak-display"><strong>í˜„ì¬ ì—°ìŠ¹: 0</strong></p>
              <button id="submit-ranking">ğŸ† ë­í‚¹ ë“±ë¡í•˜ê¸°</button>
              <button id="view-ranking">ğŸ“‹ ë­í‚¹ í™•ì¸í•˜ê¸°</button>
            </div>
            <!-- ë­í‚¹ ê²°ê³¼ íŒì—… -->
            <div id="ranking-popup" class="hidden" style="
              position: fixed;
              top: 20%;
              left: 50%;
              transform: translate(-50%, 0);
              background-color: white;
              border: 2px solid #5c6bc0;
              border-radius: 10px;
              padding: 20px;
              width: 90%;
              max-width: 400px;
              box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
              z-index: 9999;
            ">
              <h3>ğŸ† ì „ì²´ ë­í‚¹</h3>
              <ul id="ranking-list" style="padding-left: 20px; list-style: decimal;"></ul>
              <button onclick="document.getElementById('ranking-popup').classList.add('hidden')">ë‹«ê¸°</button>
            </div>
            <h2>ê²Œì„ ì‹œì‘</h2>
            <button id="start-game">ê²Œì„ ì‹œì‘í•˜ê¸°</button>
        </div>
        
        <div id="game-area" class="hidden">
            <div id="topic-info" class="topic-info"></div>
            
            <div id="statement-section" class="game-section hidden">
                <h2>ì£¼ì œì–´ì— ëŒ€í•œ í•œë§ˆë”” ì‘ì„±</h2>
                <div id="players-statements"></div>
                <div id="statement-input" class="input-area">
                    <input type="text" id="statement" placeholder="ì£¼ì œì–´ì— ê´€í•œ í•œë§ˆë””ë¥¼ ì…ë ¥í•˜ì„¸ìš” (30ì ì´ë‚´)" maxlength="30">
                    <button id="submit-statement">ì œì¶œ</button>
                </div>
            </div>
            
            <div id="discussion-section" class="game-section hidden">
                <h2>ë¼ì´ì–´ ì¶”ë¦¬ í† ë¡ </h2>
                <div id="discussion-statements"></div>
                <div id="discussion-input" class="input-area">
                    <input type="text" id="opinion" placeholder="ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš” (50ì ì´ë‚´)" maxlength="50">
                    <button id="submit-opinion">ì œì¶œ</button>
                </div>
            </div>
            <div id="vote-result-popup" class="hidden" style="
                position: fixed;
                top: 30%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 2px solid #3f51b5;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                text-align: center;
                z-index: 9999;
                font-size: 18px;
              ">
                <p id="vote-result-text"></p>
            </div>
            <div id="liar-found-popup" class="hidden" style="
              position: fixed;
              top: 30%;
              left: 50%;
              transform: translate(-50%, -50%);
              background: #e8f5e9;
              border: 2px solid #4caf50;
              border-radius: 10px;
              padding: 20px;
              box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
              text-align: center;
              z-index: 9999;
              font-size: 18px;
              color: #2e7d32;
            ">
              <p>ğŸ‰ ë¼ì´ì–´ë¥¼ ë§ì·„ìŠµë‹ˆë‹¤!<br>ì´ì œ ë¼ì´ì–´ê°€ ì£¼ì œì–´ë¥¼ ì¶”ë¡ í•  ì‹œê°„ì…ë‹ˆë‹¤.</p>
            </div>
                <div id="ai-vote-wait-popup" class="hidden" style="
                position: fixed;
                top: 30%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #fffde7;
                border: 2px solid #fbc02d;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                text-align: center;
                z-index: 9999;
                font-size: 18px;
                color: #f57f17;
              ">
                <p>ğŸ¤– AIë“¤ì´ íˆ¬í‘œ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
           </div>
            <div id="vote-section" class="game-section hidden">
                <h2>ë¼ì´ì–´ íˆ¬í‘œ</h2>
                <p>ë¼ì´ì–´ë¼ê³  ìƒê°í•˜ëŠ” í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš”:</p>
                <div id="vote-options" class="vote-area"></div>
                <button id="submit-vote" class="disabled">íˆ¬í‘œ ì œì¶œ</button>
            </div>
            
            <div id="final-vote-section" class="game-section hidden">
                <h2>ìµœì¢… íˆ¬í‘œ</h2>
                <p id="most-voted-player"></p>
                <p>ì´ í”Œë ˆì´ì–´ê°€ ë¼ì´ì–´ê°€ ë§ìŠµë‹ˆê¹Œ?</p>
                <button id="vote-yes">ì˜ˆ</button>
                <button id="vote-no">ì•„ë‹ˆì˜¤</button>
            </div>
            
            <div id="liar-guess-section" class="game-section hidden">
                <h2>ë¼ì´ì–´ì˜ ì£¼ì œì–´ ì¶”ë¡ </h2>
                <p id="liar-message"></p>
                <div id="liar-input" class="input-area">
                    <input type="text" id="topic-guess" placeholder="ì£¼ì œì–´ë¥¼ ì¶”ë¡ í•´ë³´ì„¸ìš”">
                    <button id="submit-guess">ì œì¶œ</button>
                </div>
            </div>
            
            <div id="result-section" class="game-section hidden">
                <h2>ê²Œì„ ê²°ê³¼</h2>
                <div id="final-result" class="final-result"></div>
                <div id="game-summary"></div>
                <button id="play-again">ë‹¤ì‹œ í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        // ì—°ìŠ¹ ê´€ë ¨ ë³€ìˆ˜
        let winStreak = Number(localStorage.getItem("winStreak") || "0");

        const submittedRankings = JSON.parse(localStorage.getItem("submittedRankings") || "[]");

        // DOM ìš”ì†Œ
        const streakDisplay = document.getElementById("streak-display");
        const submitRankingButton = document.getElementById("submit-ranking");
        const viewRankingButton = document.getElementById("view-ranking");

        // ì—°ìŠ¹ í‘œì‹œ ë° ë²„íŠ¼ ì œì–´
        function updateStreakUI() {
          streakDisplay.innerHTML = `<strong>í˜„ì¬ ì—°ìŠ¹: ${winStreak}</strong>`;
        }
        updateStreakUI();

        // âœ… ê²Œì„ ìŠ¹ë¦¬ ì‹œ ì—°ìŠ¹ ì¦ê°€
        function incrementWinStreak() {
          winStreak++;
          localStorage.setItem("winStreak", winStreak.toString());
          updateStreakUI();
        }

        // âŒ ê²Œì„ íŒ¨ë°° ì‹œ ì—°ìŠ¹ ë¦¬ì…‹
        function resetWinStreak() {
          winStreak = 0;
          localStorage.setItem("winStreak", "0");
          updateStreakUI();
        }

        // âœ… ë­í‚¹ ë“±ë¡
        submitRankingButton.addEventListener("click", async () => {
          if (winStreak < 3) {
            alert("âš ï¸ 3ì—°ìŠ¹ ì´ìƒë§Œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
            return;
          }

          const name = prompt("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:");
          if (!name) return;

          const key = `${name}-${winStreak}`;
          if (submittedRankings.includes(key)) {
            alert("âš ï¸ ì´ë¯¸ ê°™ì€ ì—°ìŠ¹ìœ¼ë¡œ ë“±ë¡í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤!");
            return;
          }

          if (localStorage.getItem("rankingSubmitted") === "true") {
            alert("âš ï¸ í•œ íŒ ë” ì§„í–‰í•œ í›„ì— ë‹¤ì‹œ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            return;
          }

          try {
            const res = await fetch("https://liar-game-backend.onrender.com/ranking", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, winStreak })
            });

            if (res.ok) {
              alert("ğŸ‰ ë­í‚¹ ë“±ë¡ ì™„ë£Œ!");
              submittedRankings.push(key);
              localStorage.setItem("submittedRankings", JSON.stringify(submittedRankings));
              localStorage.setItem("rankingSubmitted", "true"); // ë“±ë¡ ì™„ë£Œ ìƒíƒœ í‘œì‹œ
            } else {
              alert("âŒ ë“±ë¡ ì‹¤íŒ¨: ì„œë²„ ì˜¤ë¥˜");
            }
          } catch (err) {
            alert("âŒ ë“±ë¡ ì‹¤íŒ¨: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜", err);
          }
        });


        viewRankingButton.addEventListener("click", async () => {
          try {
            const res = await fetch("https://liar-game-backend.onrender.com/ranking");
            const rankings = await res.json();

            const list = document.getElementById("ranking-list");
            list.innerHTML = rankings
              .sort((a, b) => b.winStreak - a.winStreak)
              .map((entry, i) => `<li>${entry.name}: ${entry.winStreak}ì—°ìŠ¹</li>`)
              .join("");

            document.getElementById("ranking-popup").classList.remove("hidden");
          } catch {
            alert("âŒ ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
          }
        });

        // âœ… ê²Œì„ ì¢…ë£Œ ì‹œ ì˜ˆì‹œ: ê²°ê³¼ íŒë³„ í›„ ì—°ìŠ¹ ì²˜ë¦¬
        function handleGameResult(didWin) {
          if (didWin) incrementWinStreak();
          else resetWinStreak();
        }
        // ê²Œì„ ìƒíƒœ ê´€ë¦¬ 
        const gameState = {
            players: [
                { id: 0, name: "ê¹€ì¶˜ë´‰", isAI: false, tone: "" },
                { id: 1, name: "ì œì„ìŠ¤", isAI: true, tone: "ê²½ë°•í•œ ë‚¨ì ê³ ë“±í•™ìƒ ë§íˆ¬" },
                { id: 2, name: "ë§ˆì´í´", isAI: true, tone: "ì§„ì¤‘í•œ 40ëŒ€ ì•„ì¬ ë§íˆ¬" },
                { id: 3, name: "ì—˜ë¦¬ìŠ¤", isAI: true, tone: "ê¹Œì¹ í•œ 30ëŒ€ ì—¬ì„± ë§íˆ¬" },
                { id: 4, name: "ìœ ë‚˜", isAI: true, tone: "ì°©í•œ 20ëŒ€ ì—¬ì„± ë§íˆ¬" }
            ],
            lierId: null,
            topic: "",
            category: "",
            playerStatements: [],
            discussionRound: 0,
            playerOpinions: [],
            currentVotes: {},
            mostVotedPlayer: null,
            mostVotedCount: 0,
            finalVoteResult: null,
            gameStage: "start",
            playerOrder: [],
            currentPlayerIndex: 0,
            statementsInfo: "",
            opinionsInfo: "",
            finalVoteFailedOnce : false,
        }; 

        // ì£¼ì œì™€ ì¹´í…Œê³ ë¦¬
const topics = {
  "ê³¼ì¼": [
    "ì‚¬ê³¼", "ë°”ë‚˜ë‚˜", "ë”¸ê¸°", "ìˆ˜ë°•", "í¬ë„", "í‚¤ìœ„", "ë§ê³ ", "íŒŒì¸ì• í”Œ", "ì˜¤ë Œì§€",
    "ë³µìˆ­ì•„", "ìë‘", "ê·¤", "ë ˆëª¬", "ì²´ë¦¬", "ë¸”ë£¨ë² ë¦¬", "ë¼ì„", "ë©œë¡ ", "ìëª½", "ë¬´í™”ê³¼",
    "ìš©ê³¼", "ì²œí˜œí–¥", "í™ì‹œ", "ì„ë¥˜", "ì°¸ì™¸", "êµ¬ì•„ë°”", "ì•„ë³´ì¹´ë„", "ì½”ì½”ë„›"
  ],
  "ë™ë¬¼": [
    "ì‚¬ì", "ì½”ë¼ë¦¬", "ê¸°ë¦°", "íŒ¬ë”", "í˜¸ë‘ì´", "ê°•ì•„ì§€", "ê³ ì–‘ì´", "ì›ìˆ­ì´", "í† ë¼",
    "ëŒê³ ë˜", "í•˜ë§ˆ", "ìˆ˜ë‹¬", "ëŠ‘ëŒ€", "ì°¸ìƒˆ", "ê³ ë˜", "ì–‘", "í­ê·„", "ê³°", "ê±°ë¶ì´",
    "ë§", "ë‚™íƒ€", "ë‹¤ëŒì¥", "ë„ë§ˆë±€", "ì•µë¬´ìƒˆ", "ë±€", "ì½”ì•Œë¼", "ìº¥ê±°ë£¨"
  ],
  "ì§ì—…": [
    "ì˜ì‚¬", "ì„ ìƒë‹˜", "ê²½ì°°", "ì†Œë°©ê´€", "í”„ë¡œê·¸ë˜ë¨¸", "ìš”ë¦¬ì‚¬", "ë””ìì´ë„ˆ", "ë³€í˜¸ì‚¬", "ê°„í˜¸ì‚¬",
    "ë°°ìš°", "ê°€ìˆ˜", "ìš´ë™ì„ ìˆ˜", "íŒŒì¼ëŸ¿", "íŒì‚¬", "ì‘ê°€", "ë†ë¶€", "ê±´ì¶•ê°€", "ê°ë…", "ì‚¬ì„œ",
    "ìš´ì „ê¸°ì‚¬", "ë§ˆìˆ ì‚¬", "ì‚¬ì§„ì‘ê°€", "í†µì—­ì‚¬", "ë°”ë¦¬ìŠ¤íƒ€", "ì—°êµ¬ì›", "í™˜ê²½ë¯¸í™”ì›"
  ],
  "ë‚˜ë¼": [
    "í•œêµ­", "ë¯¸êµ­", "ì¼ë³¸", "ì¤‘êµ­", "í”„ë‘ìŠ¤", "ì˜êµ­", "ë…ì¼", "ì´íƒˆë¦¬ì•„", "í˜¸ì£¼",
    "ë¸Œë¼ì§ˆ", "ì¸ë„", "ì´ì§‘íŠ¸", "ë©•ì‹œì½”", "ìŠ¤í˜ì¸", "ëŸ¬ì‹œì•„", "í„°í‚¤", "ìºë‚˜ë‹¤", "ë‰´ì§ˆëœë“œ",
    "ë…¸ë¥´ì›¨ì´", "í•€ë€ë“œ", "ìŠ¤ì›¨ë´", "ë„¤ëœë€ë“œ", "ê·¸ë¦¬ìŠ¤", "ì²´ì½”", "í´ë€ë“œ", "ë² íŠ¸ë‚¨", "ì‹±ê°€í¬ë¥´"
  ],
  "ìŒì‹": [
    "ê¹€ì¹˜ì°Œê°œ", "í”¼ì", "íŒŒìŠ¤íƒ€", "ì´ˆë°¥", "í–„ë²„ê±°", "ë¹„ë¹”ë°¥", "ì§œì¥ë©´", "ì¹´ë ˆ", "ìŠ¤í…Œì´í¬",
    "ìƒëŸ¬ë“œ", "ë¼ë©´", "ë–¡ë³¶ì´", "ë‹­ê°ˆë¹„", "ìŒ€êµ­ìˆ˜", "íƒ€ì½”", "ìš°ë™", "ìƒŒë“œìœ„ì¹˜", "ë¶ˆê³ ê¸°",
    "ëœì¥êµ­", "ìˆœë‘ë¶€ì°Œê°œ", "ë¶€ëŒ€ì°Œê°œ", "ëƒ‰ë©´", "ì œìœ¡ë³¶ìŒ", "ê°ìíƒ•", "ì¹˜í‚¨", "íŒŒì „", "íŒŸíƒ€ì´"
  ],
  "ì‚¬ë¬¼": [
    "ì²­ì†Œê¸°", "ì„ í’ê¸°", "ê°€ìŠµê¸°", "ì»¤í”¼ë¨¸ì‹ ", "ë¯¹ì„œê¸°", "í† ìŠ¤í„°ê¸°", "ì „ê¸°ë°¥ì†¥", "ì „ìì‹œê³„", "í—¤ì–´ë“œë¼ì´ì–´",
    "ê±°ìš¸", "ì˜ì", "ì±…ìƒ", "ì»µ", "ì „í™”ê¸°", "ë¦¬ëª¨ì»¨", "ìŠ¤í”¼ì»¤", "ì‹œê³„", "ì¹«ì†”", "ì „êµ¬", "ëƒ‰ì¥ê³ ",
    "ì„¸íƒê¸°", "ë…¸íŠ¸ë¶", "ë§ˆìš°ìŠ¤", "í‚¤ë³´ë“œ", "í”„ë¦°í„°", "ëª¨ë‹ˆí„°", "í…€ë¸”ëŸ¬", "ì „ìë Œì§€", "ê²Œì„ê¸°", "ì„ ë°˜"
  ],
    "êµí†µìˆ˜ë‹¨": [
        "ìë™ì°¨", "ì§€í•˜ì² ", "ë²„ìŠ¤", "ë¹„í–‰ê¸°", "ê¸°ì°¨", "ìì „ê±°", "í‚¥ë³´ë“œ", "ë°°", "íƒì‹œ", "í—¬ë¦¬ì½¥í„°",
        "ìŠ¤ì¿ í„°", "íŠ¸ëŸ­", "ìš”íŠ¸", "ìœ ëŒì„ ", "íŠ¸ë¨", "ì „ë™íœ ", "ì „ê¸°ì°¨", "ê³ ì†ì—´ì°¨", "ë¹„í–‰ì„ ", "ìš°ì£¼ì„ ", "ê²½ë¹„í–‰ê¸°"
    ],
  "ìŠ¤í¬ì¸ ": [
  "ì¶•êµ¬", "ì•¼êµ¬", "ë†êµ¬", "ë°°êµ¬", "í…Œë‹ˆìŠ¤", "íƒêµ¬", "ìŠ¤í‚¤", "ìŠ¤ë…¸ë³´ë“œ", "ê³¨í”„",
  "ì”¨ë¦„", "ì–‘ê¶", "ìˆ˜ì˜", "ë³µì‹±", "ëŸ­ë¹„", "í•¸ë“œë³¼", "í•˜í‚¤", "ì²´ì¡°", "ìœ¡ìƒ", "ìŠ¤ì¼€ì´íŠ¸",
  "ì‚¬ì´í´", "í´ë¼ì´ë°"
],
  "ì¥ì†Œ": [
  "í•™êµ", "ë„ì„œê´€", "ë³‘ì›", "ì‹ë‹¹", "ì¹´í˜", "ì§€í•˜ì² ì—­", "ê³µì›", "ë†€ì´ê³µì›", "ì˜í™”ê´€", "í¸ì˜ì ",
  "ë°±í™”ì ", "ë§ˆíŠ¸", "í—¬ìŠ¤ì¥", "ì²´ìœ¡ê´€", "í•´ë³€", "ì‚°", "ë†€ì´ë°©", "ë²„ìŠ¤í„°ë¯¸ë„", "ê³µí•­", "í˜¸í…”",
  "ë¯¸ìˆ ê´€", "ë°•ë¬¼ê´€", "ìˆ˜ì˜ì¥", "ì„œì ", "ê³µì¥", "ì¹´ì§€ë…¸"
], 
   "ì˜í™” ì´ë¦„": ["íƒ€ì´íƒ€ë‹‰", "ì–´ë²¤ì ¸ìŠ¤", "ì¸ì…‰ì…˜", "ë°˜ì§€ì˜ ì œì™•", "ì¸í„°ìŠ¤í…”ë¼", "ì•„ë°”íƒ€", "ë§¤íŠ¸ë¦­ìŠ¤", "ì¡°ì»¤"],
  "ì„¸ê³„ ëª…ì†Œ": ["ì—í íƒ‘", "ììœ ì˜ ì—¬ì‹ ìƒ", "í”¼ë¼ë¯¸ë“œ", "ë§Œë¦¬ì¥ì„±", "ì½œë¡œì„¸ì›€", "íƒ€ì§€ë§ˆí• ", "ë§ˆì¶”í”½ì¶”", "ì‹œë“œë‹ˆ ì˜¤í˜ë¼í•˜ìš°ìŠ¤", "ê·¸ëœë“œìºë‹ˆì–¸"]
};


        // UI ìš”ì†Œ ì°¸ì¡°
        const startSection = document.getElementById("start-section");
        const gameArea = document.getElementById("game-area");
        const topicInfo = document.getElementById("topic-info");
        const statementSection = document.getElementById("statement-section");
        const playersStatements = document.getElementById("players-statements");
        const statementInput = document.getElementById("statement");
        const submitStatement = document.getElementById("submit-statement");
        const discussionSection = document.getElementById("discussion-section");
        const discussionStatements = document.getElementById("discussion-statements");
        const opinionInput = document.getElementById("opinion");
        const submitOpinion = document.getElementById("submit-opinion");
        const voteSection = document.getElementById("vote-section");
        const voteOptions = document.getElementById("vote-options");
        const submitVote = document.getElementById("submit-vote");
        const finalVoteSection = document.getElementById("final-vote-section");
        const mostVotedPlayerElement = document.getElementById("most-voted-player");
        const voteYes = document.getElementById("vote-yes");
        const voteNo = document.getElementById("vote-no");
        const liarGuessSection = document.getElementById("liar-guess-section");
        const liarMessage = document.getElementById("liar-message");
        const topicGuess = document.getElementById("topic-guess");
        const submitGuess = document.getElementById("submit-guess");
        const resultSection = document.getElementById("result-section");
        const finalResult = document.getElementById("final-result");
        const gameSummary = document.getElementById("game-summary");
        const playAgain = document.getElementById("play-again");

        // ê²Œì„ ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById("start-game").addEventListener("click", function() {
            console.log("Start game button clicked");
            startGame();
        });
      
        statementInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
              e.preventDefault();
              submitStatement.click();
          }
        });
      
        opinionInput.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                submitOpinion.click();
            }
        });
          topicGuess.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                submitGuess.click();
            }
        });


        // ê²Œì„ ì‹œì‘ í•¨ìˆ˜
        function startGame() {
            // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
            console.log("Starting game...");
            resetGameState();
            
            // ë¼ì´ì–´ ì§€ì • (0-3 ì¤‘ ëœë¤)
            gameState.lierId = Math.floor(Math.random() * 5);
            
            // ì¹´í…Œê³ ë¦¬ ë° ì£¼ì œì–´ ì„ ì •
            const categories = Object.keys(topics);
            gameState.category = categories[Math.floor(Math.random() * categories.length)];
            const topicList = topics[gameState.category];
            gameState.topic = topicList[Math.floor(Math.random() * topicList.length)];
            
            // í”Œë ˆì´ì–´ ìˆœì„œ ëœë¤ ì§€ì • 
            gameState.playerOrder = [0, 1, 2, 3, 4].sort(() => Math.random() - 0.5);
            
            // UI ì—…ë°ì´íŠ¸
            startSection.classList.add("hidden");
            gameArea.classList.remove("hidden");
            
            // ì£¼ì œ ì •ë³´ í‘œì‹œ
            if (gameState.lierId === 0) {
                // í”Œë ˆì´ì–´ê°€ ë¼ì´ì–´ì¸ ê²½ìš°
                topicInfo.innerHTML = `<p>ë‹¹ì‹ ì€ <strong>ë¼ì´ì–´</strong>ì…ë‹ˆë‹¤!</p>
                                     <p>ì¹´í…Œê³ ë¦¬: <strong>${gameState.category}</strong></p>
                                     <p>ì£¼ì œì–´ëŠ” ì•Œ ìˆ˜ ì—†ì§€ë§Œ, ë‹¤ë¥¸ ì‚¬ëŒë“¤ì˜ ë°œì–¸ì„ ë“£ê³  ì¶”ì¸¡í•´ë³´ì„¸ìš”.</p>`;
            } else {
                // í”Œë ˆì´ì–´ê°€ ì‹œë¯¼ì¸ ê²½ìš°
                topicInfo.innerHTML = `<p>ë‹¹ì‹ ì€ <strong>ì‹œë¯¼</strong>ì…ë‹ˆë‹¤!</p>
                                     <p>ì¹´í…Œê³ ë¦¬: <strong>${gameState.category}</strong></p>
                                     <p>ì£¼ì œì–´: <strong>${gameState.topic}</strong></p>`;
            }
            
            // í•œë§ˆë”” ì‘ì„± ë‹¨ê³„ ì‹œì‘
            startStatementPhase();
        }

        // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
        function resetGameState() {
            gameState.lierId = null;
            gameState.topic = "";
            gameState.category = "";
            gameState.playerStatements = [];
            gameState.discussionRound = 0;
            gameState.playerOpinions = [];
            gameState.currentVotes = {};
            gameState.mostVotedPlayer = null;
            gameState.finalVoteResult = null;
            gameState.gameStage = "start";
            gameState.playerOrder = [];
            gameState.currentPlayerIndex = 0;
            gameState.finalVoteFailedOnce = false;
        }

        // í•œë§ˆë”” ì‘ì„± ë‹¨ê³„ ì‹œì‘
        function startStatementPhase() {
            gameState.gameStage = "statement";
            statementSection.classList.remove("hidden");
            playersStatements.innerHTML = "";

            // UI ì¤€ë¹„
            for (const playerId of gameState.playerOrder) {
                const player = gameState.players.find(p => p.id === playerId);
                const playerElement = document.createElement("div");
                playerElement.className = `player ${player.id === 0 ? "you" : ""}`;
                playerElement.id = `player-statement-${player.id}`;
                playerElement.innerHTML = `<p>${player.name}</p>
                                           <p class="statement" id="statement-${player.id}">...</p>`;
                playersStatements.appendChild(playerElement);
            }

            // ìˆœì„œëŒ€ë¡œ ë°œì–¸ ì‹œì‘
            gameState.currentPlayerIndex = 0;
            handleNextStatement();
        }
      
        async function handleNextStatement() {
            // ìˆœì„œ ëë‚¬ìœ¼ë©´ ë‹¤ìŒ ë‹¨ê³„ë¡œ
            if (gameState.currentPlayerIndex >= gameState.playerOrder.length) {
                // í•œë§ˆë”” ì„¹ì…˜ ìˆ¨ê¸°ê³  â†’ ì¶”ë¦¬ ë‹¨ê³„ë¡œ
                statementSection.classList.add("hidden");
                startDiscussionPhase();
                return;
            }

            const currentId = gameState.playerOrder[gameState.currentPlayerIndex];
            const player = gameState.players.find(p => p.id === currentId);

            if (player.id === 0) {
                // í”Œë ˆì´ì–´ ì°¨ë¡€
                statementInput.value = "";
                statementInput.disabled = false;
                submitStatement.disabled = false;
                statementInput.focus();
            } else {
              
              
              const indexInOrder = gameState.playerOrder.indexOf(player.id);

              let previousStatements = "";

              if (indexInOrder > 0) {
                  previousStatements = gameState.playerOrder
                      .slice(0, indexInOrder)
                      .map(id => {
                          const p = gameState.players.find(p => p.id === id);
                          const s = gameState.playerStatements[id];
                          return s ? `${p.name}: "${s}"` : null;
                      })
                      .filter(Boolean)
                      .join("\n");
              }

                // AI í”Œë ˆì´ì–´ ì‘ë‹µ ìƒì„±
              const aiPrompt = `ë‹¹ì‹ ì€ ë¼ì´ì–´ ê²Œì„ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.

              ${
                player.id === gameState.lierId
                  ? `ë‹¹ì‹ ì€ **ë¼ì´ì–´**ì…ë‹ˆë‹¤.  
              ë‹¹ì‹ ì˜ ì´ë¦„ì€ '${player.name}'ì´ê³  ë§íˆ¬ëŠ” '${player.tone}'ì…ë‹ˆë‹¤.  
              ì¹´í…Œê³ ë¦¬ëŠ” '${gameState.category}'ì…ë‹ˆë‹¤.  
              ì£¼ì œì–´ì— ëŒ€í•œ íŒíŠ¸ë¥¼ 30ì ì´ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ë‹¹ì‹ ì€ ì£¼ì œì–´ë¥¼ ëª¨ë¥´ë¯€ë¡œ, ë“¤í‚¤ì§€ ì•Šë„ë¡ ì‹ ì¤‘í•˜ê²Œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

              ğŸ“Œ ì£¼ì˜ì‚¬í•­:
              1. ì£¼ì œì–´ê°€ ë°œì–¸ì— í¬í•¨ë˜ë©´ ì ˆëŒ€ë¡œ ì•ˆ ë©ë‹ˆë‹¤.  
              2. ë°œì–¸ë§Œ ë³´ê³  ì£¼ì œì–´ë¥¼ ìœ ì¶”í•  ìˆ˜ ìˆì„ ì •ë„ì˜ íŒíŠ¸ëŠ” ê¸ˆì§€ì…ë‹ˆë‹¤.  
              3. **ë¯¸ì‚¬ì—¬êµ¬, ì¥í™©í•œ í‘œí˜„, ê²Œì„ê³¼ ë¬´ê´€í•œ ë©˜íŠ¸, ë³¸ì¸ ì´ë¦„ ì–¸ê¸‰** ëª¨ë‘ ê¸ˆì§€ì…ë‹ˆë‹¤.

              ì§€ê¸ˆê¹Œì§€ì˜ ë‹¤ë¥¸ í”Œë ˆì´ì–´ ë°œì–¸:
              ${previousStatements || "(ì—†ìŒ)"}

              ì´ ë°œì–¸ë“¤ì„ ì°¸ê³ í•´ íë¦„ì— ë§ì¶° ë§í•´ì£¼ì„¸ìš”.`
                  : `ë‹¹ì‹ ì€ **ì‹œë¯¼**ì…ë‹ˆë‹¤.  
              ì¹´í…Œê³ ë¦¬ëŠ” '${gameState.category}'ì´ê³ , ì£¼ì œì–´ëŠ” '${gameState.topic}'ì…ë‹ˆë‹¤.  
              ë‹¹ì‹ ì˜ ì´ë¦„ì€ '${player.name}'ì´ê³  ë§íˆ¬ëŠ” '${player.tone}'ì…ë‹ˆë‹¤.  
              ì£¼ì œì–´ì— ëŒ€í•œ íŒíŠ¸ë¥¼ 30ì ì´ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.

              ğŸ“Œ ì£¼ì˜ì‚¬í•­:
              1. ì£¼ì œì–´ê°€ ë°œì–¸ì— í¬í•¨ë˜ë©´ ì ˆëŒ€ë¡œ ì•ˆ ë©ë‹ˆë‹¤.  
              2. ì§ì ‘ì ì¸ íŒíŠ¸ëŠ” ë¼ì´ì–´ì—ê²Œ ë„ˆë¬´ ìœ ë¦¬í•´ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë°˜ë“œì‹œ ìµœì†Œí•œì˜ íŒíŠ¸ë¡œ ë³¸ì¸ì´ ë¼ì´ì–´ê°€ ì•„ë‹˜ì„ ì…ì¦í•  ìˆ˜ ìˆëŠ” ì• ë§¤ëª¨í˜¸í•œ íŒíŠ¸ë¥¼ ì œê³µí•˜ì„¸ìš”.
              3. ë°œì–¸ë§Œ ë³´ê³  ì£¼ì œì–´ë¥¼ ìœ ì¶”í•  ìˆ˜ ìˆì„ ì •ë„ì˜ íŒíŠ¸ëŠ” ê¸ˆì§€ì…ë‹ˆë‹¤.  
              4. **ë¯¸ì‚¬ì—¬êµ¬, ì¥í™©í•œ í‘œí˜„, ê²Œì„ê³¼ ë¬´ê´€í•œ ë©˜íŠ¸, ë³¸ì¸ ì´ë¦„ ì–¸ê¸‰** ëª¨ë‘ ê¸ˆì§€ì…ë‹ˆë‹¤.

              ì§€ê¸ˆê¹Œì§€ì˜ ë‹¤ë¥¸ í”Œë ˆì´ì–´ ë°œì–¸:
              ${previousStatements || "(ì—†ìŒ)"}`
              }
              `;
                const aiResponse = await getAIResponse(player, aiPrompt, 70);
                gameState.playerStatements[player.id] = aiResponse;
                document.getElementById(`statement-${player.id}`).textContent = aiResponse;
                //console.log(`í•œë§ˆë”” í”„ë¡¬í”„íŠ¸: ${aiPrompt}`);
                // ë‹¤ìŒ ì‚¬ëŒ ì°¨ë¡€
                gameState.currentPlayerIndex++;
                setTimeout(() => {
                    handleNextStatement();
                }, 1000);
            }
        }
     /*
        // AI í”Œë ˆì´ì–´ ë°œì–¸ ì²˜ë¦¬
        async function processAIStatements() {
            for (const playerId of gameState.playerOrder) {
                const player = gameState.players.find(p => p.id === playerId);
                
                if (player.id === 0) {
                    // í”Œë ˆì´ì–´ ì°¨ë¡€ì´ë©´ ì…ë ¥ UI í™œì„±í™”
                    statementInput.value = "";
                    statementInput.focus();
                    continue;
                }
              const previousStatements = gameState.playerOrder
              .slice(0, gameState.playerOrder.indexOf(playerId))
              .map(id => {
                  const p = gameState.players.find(p => p.id === id);
                  const s = gameState.playerStatements[id];
                  return s ? `${p.name}: "${s}"` : null;
              })
              .filter(Boolean)
              .join("\n");
                
                // AI í”Œë ˆì´ì–´ ì‘ë‹µ ìƒì„±
                const aiPrompt = `ë‹¹ì‹ ì€ ë¼ì´ì–´ ê²Œì„ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤. ${player.id === gameState.lierId ? 
                    `ë‹¹ì‹ ì€ ë¼ì´ì–´ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì´ë¦„ì€ '${player.name}'ì´ê³  ë‹¹ì‹ ì˜ ë§íˆ¬ëŠ” '${player.tone}'ì„ ì§€ì¼œì„œ ë§í•´ì£¼ì„¸ìš”. ì¹´í…Œê³ ë¦¬ëŠ” '${gameState.category}'ì…ë‹ˆë‹¤. ì£¼ì œì–´ì— ëŒ€í•œ íŒíŠ¸ë¥¼ 30ì ì´ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ë‹¹ì‹ ì€ ë¼ì´ì–´ì´ê³  ì£¼ì œì–´ë¥¼ ëª¨ë¥´ê¸° ë•Œë¬¸ì— ë“¤í‚¤ì§€ ì•Šë„ë¡ ì˜ ë‹µë³€í•˜ì„¸ìš”. ë°œì–¸ì— ë³¸ì¸ ì´ë¦„ê³¼ ê°™ì´ ê²Œì„ê³¼ ê´€ë ¨ì—†ëŠ” ë§ì€ ì¼ì²´ ê¸ˆì§€. ì§€ê¸ˆê¹Œì§€ì˜ ë‹¤ë¥¸ í”Œë ˆì´ì–´ ë°œì–¸: ${previousStatements || "(ì—†ìŒ)"}` : 
                    `ë‹¹ì‹ ì€ ì‹œë¯¼ì…ë‹ˆë‹¤. ì£¼ì œì–´ëŠ” '${gameState.topic}'ì…ë‹ˆë‹¤.`} ë‹¹ì‹ ì˜ ì´ë¦„ì€ '${player.name}'ì´ê³  ë‹¹ì‹ ì˜ ë§íˆ¬ëŠ” '${player.tone}'ì„ ì§€ì¼œì„œ ë§í•´ì£¼ì„¸ìš”. ì£¼ì œì–´ì— ëŒ€í•œ íŒíŠ¸ë¥¼ 30ì ì´ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ì£¼ì œì–´ê°€ í•œë§ˆë””ì•ˆì— í¬í•¨ë˜ë©´ ì ˆëŒ€ë¡œ ì•ˆë˜ë©°, ë„ˆë¬´ ì§ì ‘ì ì¸ íŒíŠ¸ëŠ” ë¼ì´ì–´ì—ê²Œ ë„ˆë¬´ ìœ ë¦¬í•´ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ê°„ì ‘ì ì´ê³  ëª¨í˜¸í•˜ë„ë¡ íŒíŠ¸ë¥¼ ì£¼ì„¸ìš”. ë°œì–¸ì— ë³¸ì¸ ì´ë¦„ê³¼ ê°™ì´ ê²Œì„ê³¼ ê´€ë ¨ì—†ëŠ” ë§ì€ ì¼ì²´ ê¸ˆì§€. ì§€ê¸ˆê¹Œì§€ì˜ ë‹¤ë¥¸ í”Œë ˆì´ì–´ ë°œì–¸: ${previousStatements || "(ì—†ìŒ)"}`;
                console.log("í”„ë¡¬í”„íŠ¸", aiPrompt); 
                const aiResponse = await getAIResponse(player, aiPrompt, 70);
                
                // ë°œì–¸ ì €ì¥ ë° UI ì—…ë°ì´íŠ¸
                gameState.playerStatements[player.id] = aiResponse;
                document.getElementById(`statement-${player.id}`).textContent = aiResponse;
                
                // ì§§ì€ ë”œë ˆì´ (UI íš¨ê³¼)
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
      */

        // í”Œë ˆì´ì–´ ë°œì–¸ ì œì¶œ
        submitStatement.addEventListener("click", function () {
            const statement = statementInput.value.trim();
            if (statement === "") {
                alert("í•œë§ˆë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            gameState.playerStatements[0] = statement;
            document.getElementById("statement-0").textContent = statement;

            // ì…ë ¥ì°½ ë¹„í™œì„±í™”
            statementInput.disabled = true;
            submitStatement.disabled = true;

            // ë‹¤ìŒ ì‚¬ëŒ ì°¨ë¡€ë¡œ
            gameState.currentPlayerIndex++;
            setTimeout(() => {
                handleNextStatement();
            }, 500);
        });

        // í† ë¡  ë‹¨ê³„ ì‹œì‘
        function startDiscussionPhase() {
            discussionStatements.innerHTML = `
              <h3>í”Œë ˆì´ì–´ë“¤ì˜ í•œë§ˆë””</h3>
              ${gameState.playerOrder.map(id => {
                  const player = gameState.players.find(p => p.id === id);
                  const statement = gameState.playerStatements[id];
                  return `<div class="message"><strong>${player.name}:</strong> ${statement}</div>`;
              }).join('')}
              <hr>
              <p><strong>ì´ì œ ë¼ì´ì–´ê°€ ëˆ„êµ¬ì¸ì§€ ì¶”ë¦¬í•´ë´…ì‹œë‹¤:</strong></p>
            `;
            gameState.gameStage = "discussion";
            gameState.discussionRound++;
            gameState.currentPlayerIndex = 0;
            gameState.playerOpinions = [];
            
            discussionSection.classList.remove("hidden");
            
            // í”Œë ˆì´ì–´ ìˆœì„œëŒ€ë¡œ ì˜ê²¬ ë°œí‘œ
            processAIOpinions();
        }

        // AI ì˜ê²¬ ì²˜ë¦¬
        async function processAIOpinions() {
            for (const playerId of gameState.playerOrder) {
                const player = gameState.players.find(p => p.id === playerId);
                
                if (player.id === 0) {
                    // í”Œë ˆì´ì–´ ì°¨ë¡€ì´ë©´ ì…ë ¥ UI í™œì„±í™”
                    opinionInput.value = "";
                    opinionInput.focus();
                    continue;
                }
                
                // AI í”Œë ˆì´ì–´ ì‘ë‹µ ìƒì„±
                const statementsInfo = gameState.playerOrder.map(id => {
                    const player = gameState.players.find(p => p.id === id);
                    const statement = gameState.playerStatements[id] || "(ì•„ì§ ë°œì–¸ ì—†ìŒ)";
                    return `${player.name}: "${statement}"`;
                }).join("\n");
                
                
              
                const aiPrompt = `
                ë‹¹ì‹ ì€ ë¼ì´ì–´ ê²Œì„ì— ì°¸ê°€ ì¤‘ì¸ AI í”Œë ˆì´ì–´ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì´ë¦„ì€ '${player.name}'ì´ê³  ë‹¹ì‹ ì˜ ë§íˆ¬ëŠ” '${player.tone}'ì…ë‹ˆë‹¤.

                ${player.id !== gameState.lierId ? 
                    `ë‹¹ì‹ ì€ ì‹œë¯¼ì´ë©°, ì¹´í…Œê³ ë¦¬: '${gameState.category}'ì´ê³  ì£¼ì œì–´ëŠ” '${gameState.topic}'ì…ë‹ˆë‹¤.` :
                    `ë‹¹ì‹ ì€ ë¼ì´ì–´ì´ë©°, ì£¼ì œì–´ëŠ” ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬: '${gameState.category}'ë§Œ ì•Œê³  ìˆìŠµë‹ˆë‹¤.`}
 
                ëª¨ë“  í”Œë ˆì´ì–´ì˜ ë°œì–¸ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
                ${statementsInfo}

                ë¼ì´ì–´ê°€ ëˆ„êµ¬ë¼ê³  ìƒê°í•˜ëŠ”ì§€ 30ì ì´ë‚´ë¡œ ê°„ë‹¨íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”. íŒë‹¨ì˜ ê·¼ê±°ëŠ” ë‹¤ìŒì„ ë”°ë¥´ì„¸ìš”. 
                1. ì°¸ê°€ìë“¤ì˜ íŒíŠ¸ë¥¼ í•˜ë‚˜ì”© ë³´ë©´ì„œ ì£¼ì œì–´ë‘ ê´€ë ¨ì´ ìˆê³ , ë§ëŠ” ë§ì¸ì§€ íŒë‹¨í•˜ì„¸ìš”. ê°€ì¥ ê´€ë ¨ì´ ì ê³  ì–´ê¸‹ë‚œ ì‚¬ëŒì´ ë¼ì´ì–´ì…ë‹ˆë‹¤.
                2. ëª¨ë‘ê°€ ì •í™•íˆ ë§ëŠ” ë§ì„ í–ˆë‹¤ë©´ íŒíŠ¸ê°€ ë„ˆë¬´ í¬ê´„ì ì¸ê°€? ê·¸ë ‡ë‹¤ë©´ ë¼ì´ì–´ì…ë‹ˆë‹¤.

                ë‘ ë¬¸ì¥ ì´ë‚´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”. ë°œì–¸ì—ëŠ” "ì ˆëŒ€ë¡œ ì£¼ì œì–´ê°€ í¬í•¨ë˜ì–´ì„œëŠ” ì•ˆë©ë‹ˆë‹¤." ë‹µë³€ì€ 'ì´ë¦„, ì´ìœ 'ìˆœìœ¼ë¡œ ë‹µë³€í•  ê²ƒ.ì ˆëŒ€ '${player.name}'ì„ ì§€ëª©í•´ì„œëŠ” ì•ˆë©ë‹ˆë‹¤. ë‹µë³€ì— '${player.name}'ê°€ ì ˆëŒ€ ë“¤ì–´ê°€ë©´ ì•ˆë¨. 
                `;
                const aiOpinion = await getAIResponse(player, aiPrompt, 100);
                
                // ì˜ê²¬ ì €ì¥ ë° UI ì—…ë°ì´íŠ¸
                gameState.playerOpinions[player.id] = aiOpinion;
                const opinionElement = document.createElement("div");
                opinionElement.className = "message";
                opinionElement.innerHTML = `<strong>${player.name}:</strong> ${aiOpinion}`;
                discussionStatements.appendChild(opinionElement);
                
                // ì§§ì€ ë”œë ˆì´ (UI íš¨ê³¼)
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        // í”Œë ˆì´ì–´ ì˜ê²¬ ì œì¶œ
        submitOpinion.addEventListener("click", function() {
            const opinion = opinionInput.value.trim();
            
            if (opinion === "") {
                alert("ì˜ê²¬ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return; 
            }
            
            // ì˜ê²¬ ì €ì¥ ë° UI ì—…ë°ì´íŠ¸
            gameState.playerOpinions[0] = opinion;
            const opinionElement = document.createElement("div");
            opinionElement.className = "message";
            opinionElement.innerHTML = `<strong>${gameState.players[0].name}:</strong> ${opinion}`;
            discussionStatements.appendChild(opinionElement);
            
            // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰
            setTimeout(() => {
                discussionSection.classList.add("hidden");
                startVotePhase();
            }, 1000);
        });
        
    function waitForAIVotesOrTimeout() {
      return Promise.race([
        processAIVotes(),          // AI íˆ¬í‘œ ì™„ë£Œê¹Œì§€ ëŒ€ê¸°
        new Promise(resolve => setTimeout(resolve, 7000)) // 7ì´ˆ í›„ì—ë„ ê³„ì† ì§„í–‰
      ]);
    }
        // íˆ¬í‘œ ë‹¨ê³„ ì‹œì‘
function startVotePhase() {
    gameState.gameStage = "vote";
    gameState.currentVotes = {};

    // ì²˜ìŒì—” íˆ¬í‘œì°½ ìˆ¨ê¸°ê¸°
    voteSection.classList.add("hidden");

    // í”Œë ˆì´ì–´ ìš”ì•½ ì´ˆê¸°í™” ë° í‘œì‹œ ì¤€ë¹„
    const summaryDiv = document.createElement("div");
    summaryDiv.innerHTML = `
      <h3>í”Œë ˆì´ì–´ ìš”ì•½</h3>
      ${gameState.playerOrder.map(id => { 
          const player = gameState.players.find(p => p.id === id);
          const statement = gameState.playerStatements[id] || "(ë°œì–¸ ì—†ìŒ)";
          const opinion = gameState.playerOpinions[id] || "(ì˜ê²¬ ì—†ìŒ)";
          return `<div class="message">
                    <strong>${player.name}</strong><br>
                    ğŸ—£ï¸ í•œë§ˆë””: ${statement}<br>
                    ğŸ’¬ ì˜ê²¬: ${opinion}
                  </div>`;
      }).join('')}
      <hr>
    `;

    voteSection.insertBefore(summaryDiv, voteOptions);
    voteOptions.innerHTML = "";


    // ì‹¤í–‰ ì½”ë“œ
    document.getElementById("ai-vote-wait-popup").classList.remove("hidden");

    waitForAIVotesOrTimeout().then(() => {
      document.getElementById("ai-vote-wait-popup").classList.add("hidden");

        voteSection.classList.remove("hidden");
    
        // íˆ¬í‘œ ì˜µì…˜ ìƒì„±
        gameState.players.forEach(player => {
          const voteOption = document.createElement("div");
          voteOption.className = "vote-player";
          voteOption.id = `vote-option-${player.id}`;
          voteOption.innerHTML = `<p>${player.name}</p>`;
          voteOption.addEventListener("click", function () {
            document.querySelectorAll(".vote-player").forEach(el => el.classList.remove("selected"));
            this.classList.add("selected");
            submitVote.classList.remove("disabled");
          });
          voteOptions.appendChild(voteOption);
        });
      });

}
      
      function renderVoteOptions() {
            voteOptions.innerHTML = ""; // ê¸°ì¡´ "AI íˆ¬í‘œ ì¤‘" ë¬¸êµ¬ ì œê±°

            gameState.players.forEach(player => {
                const voteOption = document.createElement("div");
                voteOption.className = "vote-player";
                voteOption.id = `vote-option-${player.id}`;
                voteOption.innerHTML = `<p>${player.name}</p>`;
                voteOption.addEventListener("click", function () {
                    // ì´ì „ ì„ íƒ ì´ˆê¸°í™”
                    document.querySelectorAll(".vote-player").forEach(el => el.classList.remove("selected"));
                    this.classList.add("selected");

                    // ë²„íŠ¼ í™œì„±í™”
                    submitVote.classList.remove("disabled");
                });
                voteOptions.appendChild(voteOption);
            });
        }
        // AI íˆ¬í‘œ ì²˜ë¦¬
        async function processAIVotes() {
            // ê° AI í”Œë ˆì´ì–´ íˆ¬í‘œ ì²˜ë¦¬
            for (let i = 1; i < 5; i++) {
                const aiPlayer = gameState.players.find(p => p.id === i);

                // ëª¨ë“  í”Œë ˆì´ì–´ì˜ ë°œì–¸ ì •ë³´ ìˆ˜ì§‘
                const statementsInfo = gameState.playerOrder.map(id => {
                    const p = gameState.players.find(p => p.id === id);
                    return `${p.name}: "${gameState.playerStatements[p.id]}"`;
                }).join("\n");

                // í† ë¡  ì˜ê²¬ë„ ìˆ˜ì§‘
                const opinionsInfo = gameState.playerOrder
                    .filter(id => gameState.playerOpinions[id]) // undefined ì œì™¸
                    .map(id => {
                        const p = gameState.players.find(p => p.id === id);
                        return `${p.name}ì˜ ì˜ê²¬: "${gameState.playerOpinions[p.id]}"`;
                    }).join("\n");
                gameState.statementsInfo = statementsInfo;
                gameState.opinionsInfo = opinionsInfo;
                // API í˜¸ì¶œìš© í”„ë¡¬í”„íŠ¸ êµ¬ì„±
                const aiPrompt = `
                ë‹¹ì‹ ì€ ë¼ì´ì–´ ê²Œì„ì˜ ì°¸ê°€ìì´ë©°, ë‹¹ì‹ ì˜ ì´ë¦„ì€ '${aiPlayer.name}'ì…ë‹ˆë‹¤.
                ${i === gameState.lierId ? 
                    'ë‹¹ì‹ ì€ ë¼ì´ì–´ì…ë‹ˆë‹¤. ìì‹ ì˜ ì •ì²´ë¥¼ ìˆ¨ê¸°ê³  ì‹œë¯¼ì²˜ëŸ¼ í–‰ë™í•˜ì„¸ìš”.' : 
                    'ë‹¹ì‹ ì€ ì‹œë¯¼ì…ë‹ˆë‹¤. ë¼ì´ì–´ë¥¼ ì •í™•íˆ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.'}

        ì¹´í…Œê³ ë¦¬: '${gameState.category}'
        ${i !== gameState.lierId ? `ì£¼ì œì–´: '${gameState.topic}'` : ''}

        ëª¨ë“  í”Œë ˆì´ì–´ì˜ ë°œì–¸:
        ${statementsInfo}

        í† ë¡  ì˜ê²¬:
        ${opinionsInfo}

        ëˆ„ê°€ ë¼ì´ì–´ì¸ì§€ ë¶„ì„í•˜ê³ , ë¼ì´ì–´ë¼ê³  ìƒê°ë˜ëŠ” í”Œë ˆì´ì–´ ë²ˆí˜¸ í•˜ë‚˜ë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”. ìì‹ '${aiPlayer.name}'ì€ íˆ¬í‘œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 0ì€ ê¹€ì¶˜ë´‰, 1ì€ ì œì„ìŠ¤, 2ëŠ” ë§ˆì´í´, 3ì€ ì—˜ë¦¬ìŠ¤, 4ëŠ” ìœ ë‚˜ì…ë‹ˆë‹¤. ìˆ«ìë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”.`;

                // API í˜¸ì¶œ
                const aiResponse = await getAIResponse(aiPlayer, aiPrompt, 5);
                // ì‘ë‹µì—ì„œ ìˆ«ìë§Œ ì¶”ì¶œ
                const votedId = parseInt(aiResponse.match(/\d+/)?.[0]);

                // ìœ íš¨í•œ íˆ¬í‘œì¸ì§€ í™•ì¸ (ìì‹ ì´ ì•„ë‹ˆê³ , 0-3 ì‚¬ì´)
                if (!isNaN(votedId) && votedId >= 0 && votedId <= 4 && votedId !== i) {
                    gameState.currentVotes[i] = votedId;
                } else {
                    // ìœ íš¨í•˜ì§€ ì•Šì€ ì‘ë‹µì¸ ê²½ìš° ëœë¤ íˆ¬í‘œ (ìì‹  ì œì™¸)
                    let randomVote;
                    do {
                        randomVote = Math.floor(Math.random() * 4);
                    } while (randomVote === i);

                    gameState.currentVotes[i] = randomVote;
                }

                console.log(`${aiPlayer.name}ì˜ íˆ¬í‘œ: ${gameState.currentVotes[i]}`);
            }
        }

        // í”Œë ˆì´ì–´ íˆ¬í‘œ ì œì¶œ
        submitVote.addEventListener("click", function() {
            if (this.classList.contains("disabled")) {
                return;
            }
            
            // ì„ íƒëœ í”Œë ˆì´ì–´ í™•ì¸
            const selectedOption = document.querySelector(".vote-player.selected");
            if (!selectedOption) {
                alert("íˆ¬í‘œí•  í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }
            
            const votedId = parseInt(selectedOption.id.split("-")[2]);
            gameState.currentVotes[0] = votedId;
            
            // íˆ¬í‘œ ê²°ê³¼ ê³„ì‚°
            calculateVoteResults();
            

            // âœ… íˆ¬í‘œ UI ìˆ¨ê¹€
            voteSection.classList.add("hidden");

            // âœ… ì°¬ë°˜íˆ¬í‘œ ìƒëµ ë¡œì§
            if (gameState.finalVoteFailedOnce) {
                const votedPlayer = gameState.players.find(p => p.id === gameState.mostVotedPlayer);
                const liarIsCaught = gameState.mostVotedPlayer === gameState.lierId;

                // âœ… íˆ¬í‘œ ê²°ê³¼ íŒì—… í‘œì‹œ
                const votePopup = document.getElementById("vote-result-popup");
                const voteText = document.getElementById("vote-result-text");
                voteText.innerHTML = `
                  ğŸ” ì¬íˆ¬í‘œ ê²°ê³¼<br>
                  ìµœë‹¤ ë“í‘œì: ${votedPlayer.name}<br>
                  ë“í‘œ ìˆ˜: ${gameState.mostVotedCount}<br>
                  ì°¬ë°˜ ì—†ì´ ë°”ë¡œ ê²°ê³¼ ì²˜ë¦¬ë©ë‹ˆë‹¤.
                `;
                votePopup.classList.remove("hidden");

                setTimeout(() => {
                    votePopup.classList.add("hidden");
                    if (liarIsCaught) {
                        showLiarFoundPopup();
                    } else {
                        endGame("citizens");
                    }
                }, 3000);

                return; // âœ… ì°¬ë°˜íˆ¬í‘œ ìƒëµí•˜ê³  ì¢…ë£Œ
            }

            // âœ… ê¸°ë³¸ ë£¨íŠ¸ - ì°¬ë°˜ íˆ¬í‘œë¡œ ë„˜ì–´ê°
            startFinalVotePhase();
        });

        // íˆ¬í‘œ ê²°ê³¼ ê³„ì‚°
// íˆ¬í‘œ ê²°ê³¼ ê³„ì‚°
function calculateVoteResults() {
    const voteCounts = [0, 0, 0, 0, 0];
    
    // ê° í”Œë ˆì´ì–´ íˆ¬í‘œ ì§‘ê³„
    for (const [voterId, votedId] of Object.entries(gameState.currentVotes)) {
        voteCounts[votedId]++;
    }
    // ìµœë‹¤ ë“í‘œì ì°¾ê¸° (ë™ì ì¼ ê²½ìš° ëœë¤ ì„ íƒ)
    const maxVotes = Math.max(...voteCounts);
    const maxVotedPlayers = [];
    
    for (let i = 0; i < voteCounts.length; i++) {
        if (voteCounts[i] === maxVotes) {
            maxVotedPlayers.push(i);
        }
    }
    
    // ìµœë‹¤ ë“í‘œìê°€ ì—¬ëŸ¬ ëª…ì´ë©´ ëœë¤ ì„ íƒ
    gameState.mostVotedPlayer = maxVotedPlayers[Math.floor(Math.random() * maxVotedPlayers.length)];
    gameState.mostVotedCount = voteCounts[gameState.mostVotedPlayer];
}

// ìµœì¢… íˆ¬í‘œ ë‹¨ê³„ ì‹œì‘
function startFinalVotePhase() {
    gameState.gameStage = "finalVote";
    finalVoteSection.classList.remove("hidden");

    const mostVotedPlayer = gameState.players.find(p => p.id === gameState.mostVotedPlayer);
    mostVotedPlayerElement.textContent = `ê°€ì¥ ë§ì€ í‘œë¥¼ ë°›ì€ í”Œë ˆì´ì–´: ${mostVotedPlayer.name}`;
    mostVotedPlayerElement.innerHTML = `
    ê°€ì¥ ë§ì€ í‘œë¥¼ ë°›ì€ í”Œë ˆì´ì–´: <strong>${mostVotedPlayer.name}</strong><br>
    ë°›ì€ í‘œ ìˆ˜: <strong>${gameState.mostVotedCount}í‘œ</strong>
  `; 

    // âœ… ë²„íŠ¼ ì¬í™œì„±í™” (ì´ì „ ë¶€ê²° íˆ¬í‘œ ì´í›„)
    voteYes.disabled = false;
    voteNo.disabled = false;

    // âœ… ì´ì „ íŒì—… ìˆ¨ê¸°ê¸°
    document.getElementById("ai-vote-wait-popup").classList.add("hidden");

    // âœ… ì°¬ë°˜ íˆ¬í‘œ ê¸°ë¡ ì´ˆê¸°í™”
    finalVoteResults = {};
  
      // âœ… ì¶”ê°€: í”Œë ˆì´ì–´ë“¤ì˜ ì²«ë§ˆë”” ìš”ì•½ í‘œì‹œ
    const hintSummary = document.createElement("div");
    hintSummary.innerHTML = `
        <hr>
        <h3>í”Œë ˆì´ì–´ í•œë§ˆë”” ìš”ì•½</h3>
        ${gameState.playerOrder.map(id => {
            const player = gameState.players.find(p => p.id === id);
            const statement = gameState.playerStatements[id] || "(ë°œì–¸ ì—†ìŒ)";
            return `<div class="message">
                      <strong>${player.name}:</strong> ğŸ—£ï¸ ${statement}
                    </div>`;
        }).join("")}
    `;
    
    // ê¸°ì¡´ì— ìš”ì•½ì´ ìˆì—ˆë‹¤ë©´ ì œê±°
    const existingSummary = document.getElementById("final-hint-summary");
    if (existingSummary) existingSummary.remove();
    
    hintSummary.id = "final-hint-summary";
    finalVoteSection.appendChild(hintSummary);
}

let finalVoteResults = {}; // voterId: true/false

voteYes.addEventListener("click", function () {
    voteYes.disabled = true;
    voteNo.disabled = true;

    // âœ… AI ê¸°ë‹¤ë¦¬ëŠ” íŒì—… í‘œì‹œ
    document.getElementById("ai-vote-wait-popup").classList.remove("hidden");

    // âœ… í”Œë ˆì´ì–´ì˜ ì°¬ì„± íˆ¬í‘œ ì €ì¥
    finalVoteResults[0] = true;

    // âœ… AI ìµœì¢… íˆ¬í‘œ ì‹œì‘
    processAIFinalVotes();
});

voteNo.addEventListener("click", function () {
    voteYes.disabled = true;
    voteNo.disabled = true;

    // âœ… AI ê¸°ë‹¤ë¦¬ëŠ” íŒì—… í‘œì‹œ
    document.getElementById("ai-vote-wait-popup").classList.remove("hidden");

    // âœ… í”Œë ˆì´ì–´ì˜ ë°˜ëŒ€ íˆ¬í‘œ ì €ì¥
    finalVoteResults[0] = false;

    // âœ… AI ìµœì¢… íˆ¬í‘œ ì‹œì‘
    processAIFinalVotes();
});

async function processAIFinalVotes() {
    for (let i = 1; i <= 4; i++) {
        const ai = gameState.players[i];
        const isLiar = gameState.lierId === i;
        const mostVotedId = gameState.mostVotedPlayer;
        const votedTarget = gameState.players[mostVotedId];
        const aiPreviousVote = gameState.currentVotes[i]; // AIê°€ ì¼ë°˜ íˆ¬í‘œì—ì„œ ì°ì€ ì‚¬ëŒ
        const votedLine = 
            aiPreviousVote === mostVotedId
            ? `ğŸ‘‰ ë‹¹ì‹ ì€ ${votedTarget.name}ì—ê²Œ íˆ¬í‘œí•œ ìƒíƒœì…ë‹ˆë‹¤.`
            : `ğŸ‘‰ ë‹¹ì‹ ì€ ì›ë˜ ${gameState.players[aiPreviousVote].name}ì—ê²Œ íˆ¬í‘œí–ˆì§€ë§Œ,\në‹¤ìˆ˜ì˜ íˆ¬í‘œë¡œ ì¸í•´ ${votedTarget.name}ì´ ìµœì¢… í›„ë³´ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.`;

        const prompt = `
        ë‹¹ì‹ ì€ ë¼ì´ì–´ ê²Œì„ì— ì°¸ê°€ ì¤‘ì¸ í”Œë ˆì´ì–´ì…ë‹ˆë‹¤.
        ë‹¹ì‹ ì˜ ì´ë¦„ì€ '${ai.name}'ì´ê³  ë‹¹ì‹ ì˜ ë§íˆ¬ëŠ” '${ai.tone}'ì…ë‹ˆë‹¤.

        ğŸ—³ï¸ ì§€ê¸ˆ ë‹¹ì‹ ì€ <${votedTarget.name}> ì´(ê°€) ë¼ì´ì–´ì¸ì§€ ìµœì¢… íŒë‹¨í•˜ëŠ” ì°¬ë°˜ íˆ¬í‘œì— ì°¸ì—¬ ì¤‘ì…ë‹ˆë‹¤.
        ${votedLine}

        ${ai.id !== gameState.lierId ? 
            `ë‹¹ì‹ ì€ ì‹œë¯¼ì´ë©°, ì£¼ì œì–´ëŠ” '${gameState.topic}'ì…ë‹ˆë‹¤.
                    ë‹¤ìŒì€ ëª¨ë“  í”Œë ˆì´ì–´ì˜ ë°œì–¸ ì •ë³´ì…ë‹ˆë‹¤:

        ğŸ—£ï¸ ì²«ë§ˆë”” (ì£¼ì œ íŒíŠ¸):
        ${gameState.statementsInfo}

        ğŸ’¬ ì˜ê²¬ í† ë¡ :
        ${gameState.opinionsInfo}

        ğŸ“Œ ë¼ì´ì–´ëŠ” ì¹´í…Œê³ ë¦¬ë§Œ ì•Œê³ , ì£¼ì œì–´ë¥¼ ëª¨ë¦…ë‹ˆë‹¤.

        âš–ï¸ íŒë‹¨ ê¸°ì¤€:
        - ${votedTarget.name}ê°€ ë¼ì´ì–´ë¼ê³  ìƒê°ë˜ë©´ "ì˜ˆ"
        - ${votedTarget.name}ê°€ ì‹œë¯¼ ê°™ë‹¤ê³  ìƒê°ë˜ë©´ "ì•„ë‹ˆì˜¤"
        - ë‹¹ì‹ ì´ ë¼ì´ì–´ì´ê³  ë³¸ì¸ì´ ì§€ëª©ë˜ì—ˆë‹¤ë©´ "ì•„ë‹ˆì˜¤"
        - ë‹¹ì‹ ì´ ë¼ì´ì–´ì´ê³  ë‹¤ë¥¸ ì‚¬ëŒì´ ì§€ëª©ë˜ì—ˆë‹¤ë©´ "ì˜ˆ"
        - íˆ¬í‘œ ëŒ€ìƒì´ '${ai.name}'ë¼ë©´ ë°˜ë“œì‹œ "ì•„ë‹ˆì˜¤"
        - ëŒ€ìƒì´ ${votedTarget.name}ë¼ë©´ ì›¬ë§Œí•˜ë©´ "ì˜ˆ"
 
        âœï¸ ë°˜ë“œì‹œ ì´ìœ ì™€ í•¨ê»˜ "ì˜ˆ" ë˜ëŠ” "ì•„ë‹ˆì˜¤"ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. (ì§§ì€ ì´ìœ ëŠ” í—ˆìš©)` 
        :
            `ë‹¹ì‹ ì€ ë¼ì´ì–´ì´ë©°, ì£¼ì œì–´ëŠ” ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬: '${gameState.category}'ë§Œ ì•Œê³  ìˆìŠµë‹ˆë‹¤. ë§Œì•½ ë‹¹ì‹ :'${ai.name}'ì´ íˆ¬í‘œ ëŒ€ìƒì´ë¼ë©´ ë¬´ì¡°ê±´ ì•„ë‹ˆì˜¤ë¥¼ ê³ ë¥´ê³  ë‹¤ë¥¸ ì°¸ê°€ìë¼ë©´ ë¬´ì¡°ê±´ ì˜ˆë¥¼ ê³ ë¥´ì„¸ìš”!!
            ë°˜ë“œì‹œ "ì˜ˆ" ë˜ëŠ” "ì•„ë‹ˆì˜¤"ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”. 
            `}


        `.trim();

        const reply = await getAIResponse(gameState.players[i], prompt, 50);
        const vote = reply.includes("ì˜ˆ") ? true : false;
        finalVoteResults[i] = vote;
        // ì•½ê°„ì˜ ë”œë ˆì´ ì£¼ê¸°
        //await new Promise(resolve => setTimeout(resolve, 500));
        //console.log(`í”„ë¡¬í”„íŠ¸: ${prompt}`);
        //console.log(`ëŒ€ë‹µ: ${reply}`);
    }

    // âœ… íŒì—… ë‹«ê¸°
    document.getElementById("ai-vote-wait-popup").classList.add("hidden");
 
    // âœ… ìµœì¢… í‰ê°€
    evaluateFinalVote();
}

// ë¼ì´ì–´ì˜ ì£¼ì œì–´ ì¶”ë¡  ë‹¨ê³„ ì‹œì‘
function startLiarGuessPhase() {
    gameState.gameStage = "liarGuess";
    liarGuessSection.classList.remove("hidden");
    
    // ë¼ì´ì–´ê°€ í”Œë ˆì´ì–´ì¸ ê²½ìš°ì™€ AIì¸ ê²½ìš° ë¶„ë¦¬  
    if (gameState.lierId === 0) {
        // í”Œë ˆì´ì–´ê°€ ë¼ì´ì–´ì¸ ê²½ìš°
        liarMessage.textContent = "ë‹¹ì‹ ì´ ë¼ì´ì–´ì…ë‹ˆë‹¤! ì£¼ì œì–´ë¥¼ ì¶”ë¡ í•´ë³´ì„¸ìš”.";
        topicGuess.value = "";
        topicGuess.focus(); 
    } else {
        // AIê°€ ë¼ì´ì–´ì¸ ê²½ìš°
        const liar = gameState.players.find(p => p.id === gameState.lierId);
        liarMessage.textContent = `${liar.name}ì´(ê°€) ë¼ì´ì–´ì…ë‹ˆë‹¤! ì£¼ì œì–´ë¥¼ ì¶”ë¡ í•˜ê³  ìˆìŠµë‹ˆë‹¤...`;
        
        // AI ë¼ì´ì–´ì˜ ì¶”ë¡  ì²˜ë¦¬
        processAILiarGuess();
    }
}
      
function evaluateFinalVote() {
    finalVoteSection.classList.add("hidden");

    const yesVotes = Object.values(finalVoteResults).filter(v => v === true).length;
    const noVotes = Object.values(finalVoteResults).filter(v => v === false).length;

    // âœ… ìµœì¢… íˆ¬í‘œ ê²°ê³¼ íŒì—…ì— í‘œì‹œ
    const votePopup = document.getElementById("vote-result-popup");
    const voteText = document.getElementById("vote-result-text");

    voteText.innerHTML = `
      âœ”ï¸ ì°¬ì„±(ì˜ˆ): ${yesVotes}í‘œ<br>
      âŒ ë°˜ëŒ€(ì•„ë‹ˆì˜¤): ${noVotes}í‘œ
    `;
    votePopup.classList.remove("hidden");

    // âœ… 3ì´ˆ í›„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰
    setTimeout(() => {
        votePopup.classList.add("hidden");

        if (yesVotes >= 3) {
            if (gameState.mostVotedPlayer === gameState.lierId) {
                showLiarFoundPopup();
            } else {
                endGame("citizens");
            }
        } else {
            alert("ê³¼ë°˜ìˆ˜ ì°¬ì„±ì„ ì–»ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í† ë¡ ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤. ë‹¤ìŒ íˆ¬í‘œì—ëŠ” ì°¬ë°˜ íˆ¬í‘œë¥¼ ì§„í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            startDiscussionPhase();
            gameState.finalVoteFailedOnce = true;
        }

        finalVoteResults = {};
    }, 3000);
}

function showLiarFoundPopup() {
    const popup = document.getElementById("liar-found-popup");
    popup.classList.remove("hidden");

    setTimeout(() => {
        popup.classList.add("hidden");
        startLiarGuessPhase();
    }, 2500);
}
     
// AI ë¼ì´ì–´ì˜ ì£¼ì œì–´ ì¶”ë¡  ì²˜ë¦¬
async function processAILiarGuess() {
    const liar = gameState.players.find(p => p.id === gameState.lierId);
    
    // ë‹¤ë¥¸ í”Œë ˆì´ì–´ë“¤ì˜ ë°œì–¸ ëª¨ìŒ
    const statementsInfo = gameState.playerOrder.map(id => {
        const p = gameState.players.find(p => p.id === id);
        return `${p.name}: "${gameState.playerStatements[p.id]}"`;
    }).join("\n");
    
    const aiPrompt = `ë‹¹ì‹ ì€ ë¼ì´ì–´ ê²Œì„ì—ì„œ ë¼ì´ì–´ì…ë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ëŠ” '${gameState.category}'ì´ê³ , ë‹¤ë¥¸ í”Œë ˆì´ì–´ë“¤ì˜ ë°œì–¸ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\n${statementsInfo}\n\nì£¼ì œì–´ë¥¼ ì¶”ë¡ í•´ë³´ì„¸ìš”. ë‹µë³€ì€ ë‹¨ì–´ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”.`;
    
    
    const aiGuess = await getAIResponse(liar, aiPrompt, 30);
    
    // ì¶”ë¡  ê²°ê³¼ í‘œì‹œ ë° ê²Œì„ ì¢…ë£Œ
    liarMessage.textContent = `${liar.name}ì˜ ì¶”ë¡ : "${aiGuess}"`;
    
    // ì ì‹œ í›„ ê²Œì„ ê²°ê³¼ í‘œì‹œ
    setTimeout(() => {
        liarGuessSection.classList.add("hidden");
        
        // ì¶”ë¡  ì„±ê³µ ì—¬ë¶€ í™•ì¸
        if (aiGuess.toLowerCase().includes(gameState.topic.toLowerCase())) {
            endGame("liar", aiGuess);
        } else {
            endGame("citizens", aiGuess);
        }
    }, 3000);
}

// í”Œë ˆì´ì–´ ë¼ì´ì–´ì˜ ì£¼ì œì–´ ì¶”ë¡  ì œì¶œ
submitGuess.addEventListener("click", function() {
    const guess = topicGuess.value.trim();
    
    if (guess === "") {
        alert("ì¶”ë¡ í•œ ì£¼ì œì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }
    
    liarGuessSection.classList.add("hidden");
    
    // ì¶”ë¡  ì„±ê³µ ì—¬ë¶€ í™•ì¸
    if (guess.toLowerCase() === gameState.topic.toLowerCase()) {
        endGame("liar", guess);
    } else {
        endGame("citizens", guess);
    }
});

// ê²Œì„ ì¢…ë£Œ ë° ê²°ê³¼ í‘œì‹œ
function endGame(winner, guess) {
    gameState.gameStage = "result";
    resultSection.classList.remove("hidden");
		localStorage.setItem("rankingSubmitted", "false");
    const liar = gameState.players.find(p => p.id === gameState.lierId);
    const liarName = liar.name;
    const playerIsLiar = gameState.lierId === 0;
    const liarGuessedCorrectly = (guess || "").toLowerCase() === gameState.topic.toLowerCase();
    const liarWasCaught = gameState.mostVotedPlayer === gameState.lierId;

    let resultText = "";
    let resultClass = "";

    // === CASE 1: í”Œë ˆì´ì–´ê°€ ë¼ì´ì–´ ===
    if (playerIsLiar) {
        if (liarWasCaught) {
            if (liarGuessedCorrectly) {
                resultText = `ğŸŸ¢ ë‹¹ì‹ ì€ ë¼ì´ì–´ì˜€ê³  ì •ì²´ê°€ ë“¤í†µë‚¬ì§€ë§Œ,\nì •í™•íˆ ì£¼ì œì–´ë¥¼ ë§ì¶° **ìŠ¹ë¦¬**í–ˆìŠµë‹ˆë‹¤!`;
                handleGameResult(true);
                resultClass = "win";
            } else {
                resultText = `ğŸ”´ ë‹¹ì‹ ì€ ë¼ì´ì–´ì˜€ê³  ì •ì²´ê°€ ë“¤í†µë‚¬ê³ ,\nì£¼ì œì–´ë„ ë§ì¶”ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. **íŒ¨ë°°**ì…ë‹ˆë‹¤.`;
                handleGameResult(false);
                resultClass = "lose";
            }
        } else {
            // ë“¤í†µ ì•ˆ ë‚¨ = ì‹œë¯¼ë“¤ì´ ëª» ë§ì¶¤
            resultText = `ğŸŸ¢ ë‹¹ì‹ ì€ ë¼ì´ì–´ì˜€ê³  ì‹œë¯¼ë“¤ì€ ë‹¹ì‹ ì„ ì˜ì‹¬í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!\n\n**ì •ì²´ë¥¼ ìˆ¨ê¸°ê³  ì„±ê³µì ìœ¼ë¡œ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!**`;
            handleGameResult(true);
            resultClass = "win";
        }
    }

    // === CASE 2: í”Œë ˆì´ì–´ê°€ ì‹œë¯¼ ===
    else {
        if (liarWasCaught) {
            if (liarGuessedCorrectly) {
                resultText = `ğŸ”´ ì‹œë¯¼ë“¤ì€ ë¼ì´ì–´ ${liarName}ì˜ ì •ì²´ë¥¼ ë°í˜€ëƒˆì§€ë§Œ,\nê·¸ê°€ ì£¼ì œì–´ë¥¼ ë§ì¶° **ë¼ì´ì–´ì˜ ìŠ¹ë¦¬**ë¡œ ëë‚¬ìŠµë‹ˆë‹¤.`;
                handleGameResult(false);
                resultClass = "lose";
            } else {
                resultText = `ğŸŸ¢ ì‹œë¯¼ë“¤ì€ ë¼ì´ì–´ ${liarName}ì˜ ì •ì²´ë¥¼ ë°í˜€ëƒˆê³ ,\nê·¸ëŠ” ì£¼ì œì–´ë¥¼ ë§ì¶”ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n\n**ì‹œë¯¼ì˜ ìŠ¹ë¦¬ì…ë‹ˆë‹¤!**`;
                handleGameResult(true);
                resultClass = "win";
            }
        } else {
            // ì‹œë¯¼ë“¤ì´ ë¼ì´ì–´ë¥¼ ëª» ë§ì¶¤
            resultText = `ğŸ”´ ì‹œë¯¼ë“¤ì€ ë¼ì´ì–´ë¥¼ ë§ì¶”ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n\n${liarName}ì´(ê°€) ì •ì²´ë¥¼ ìˆ¨ê¸°ê³  **ìŠ¹ë¦¬**í–ˆìŠµë‹ˆë‹¤.`;
            handleGameResult(false);
            resultClass = "lose";
        }
    }

    // ê²°ê³¼ ì¶œë ¥
    finalResult.textContent = resultText;
    finalResult.className = `final-result ${resultClass}`;
    
    
    // ê²°ê³¼ í‘œì‹œ
    finalResult.textContent = resultText;
    finalResult.className = `final-result ${resultClass}`;
    
    // ê²Œì„ ìš”ì•½ ì •ë³´
    gameSummary.innerHTML = `
        <p>ì¹´í…Œê³ ë¦¬: <strong>${gameState.category}</strong></p>
        <p>ì£¼ì œì–´: <strong>${gameState.topic}</strong></p>
        <p>ë¼ì´ì–´: <strong>${gameState.players.find(p => p.id === gameState.lierId).name}</strong></p>
        <p>ë¼ì´ì–´ì˜ ì¶”ë¡ : <strong>${guess || "ì—†ìŒ"}</strong></p>
        <h3>í”Œë ˆì´ì–´ ë°œì–¸:</h3>
    `;
    
    // í”Œë ˆì´ì–´ ë°œì–¸ ìš”ì•½
    gameState.playerOrder.forEach(id => {
        const player = gameState.players.find(p => p.id === id);
        const statement = gameState.playerStatements[player.id];
        
        const playerSummary = document.createElement("div");
        playerSummary.className = "player";
        if (player.id === gameState.lierId) {
            playerSummary.classList.add("liar");
        }
        playerSummary.innerHTML = `<p><strong>${player.name}${player.id === gameState.lierId ? " (ë¼ì´ì–´)" : ""}</strong>: ${statement}</p>`;
        
        gameSummary.appendChild(playerSummary);
    });
}

// ë‹¤ì‹œ í•˜ê¸° ë²„íŠ¼
playAgain.addEventListener("click", function () {
    // ê²°ê³¼ í™”ë©´ ìˆ¨ê¸°ê¸°
    resultSection.classList.add("hidden");
    startSection.classList.remove("hidden"); 
    gameArea.classList.add("hidden");
    document.getElementById("vote-result-popup").classList.add("hidden");
    document.getElementById("vote-result-text").innerHTML = "";
    voteYes.disabled = false;
    voteNo.disabled = false;
    document.getElementById("ai-vote-wait-popup").classList.add("hidden");
    // âœ… ê²°ê³¼ ìš”ì•½ ë“± ë™ì ìœ¼ë¡œ ì¶”ê°€ëœ ìš”ì†Œ ì œê±°
    const summary = document.getElementById("final-vote-summary");
    if (summary) summary.remove();

    const oldSummaries = document.querySelectorAll(".message");
    oldSummaries.forEach(el => el.remove());

    // âœ… íˆ¬í‘œ ìš”ì•½, ì„ íƒ ì´ˆê¸°í™”
    voteOptions.innerHTML = "";
    gameSummary.innerHTML = "";
    finalResult.textContent = "";
    finalResult.className = "final-result";

    // âœ… ê²Œì„ ìƒíƒœ ë¦¬ì…‹
    resetGameState();
});

// ChatGPT API ì—°ë™ í•¨ìˆ˜ (ì‹¤ì œ êµ¬í˜„)
async function getAIResponseWithAPI(aiPlayer, prompt, maxLength) {
    try {
        const response = await fetch('https://liar-game-backend.onrender.com/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ prompt })
        });

        const data = await response.json();
        let aiResponse = data.reply || "ì‘ë‹µ ì—†ìŒ";
        if (maxLength && aiResponse.length > maxLength) {
            aiResponse = aiResponse.substring(0, maxLength);
        }
        
        return aiResponse;
    } catch (error) {
        console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
        return "AI ì‘ë‹µ ì˜¤ë¥˜ ë°œìƒ";
    }
}


async function getAIResponse(aiPlayer, prompt, maxLength) {
    return await getAIResponseWithAPI(aiPlayer, prompt, maxLength);
}

        </script>
</body>  
