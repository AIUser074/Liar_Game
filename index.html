<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>라이어 게임</title>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #5c6bc0;
        }
        .game-section {
            margin-bottom: 20px;
        }
        .player {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #e8eaf6;
        }
        .player.you {
            background-color: #c5cae9;
            border-left: 4px solid #3f51b5;
        }
        .player.liar {
            border-left: 4px solid #f44336;
        }
        .input-area {
            margin: 20px 0;
        }
        input[type="text"] {
            width: 70%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background-color: #5c6bc0;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-left: 10px;
        }
        button:hover {
            background-color: #3f51b5;
        }
        .disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
        }
        .disabled:hover {
            background-color: #bdbdbd;
        }
        .hidden {
            display: none;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            background-color: #e3f2fd;
            border-radius: 4px;
        }
        .vote-area {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .vote-player {
            text-align: center;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
        }
        .vote-player:hover {
            background-color: #e8eaf6;
        }
        .vote-player.selected {
            background-color: #c5cae9;
            border: 2px solid #3f51b5;
        }
        .topic-info {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #e8f5e9;
            border-radius: 5px;
            border-left: 4px solid #4caf50;
        }
        .final-result {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1.2em;
        }
        .win {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .lose {
            background-color: #ffebee;
            color: #c62828;
        }
        .rules {
            background-color: #fff8e1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .statement {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>라이어 게임</h1>
        
        <div class="rules">
            <p><strong>게임 규칙:</strong></p>
            <ol>
                <li>라이어 한 명, 시민 세 명으로 게임이 진행됩니다.</li>
                <li>라이어는 주제의 카테고리만 알고, 시민은 정확한 주제어를 알게 됩니다.</li>
                <li>모든 플레이어는 순서대로 주제어에 대한 한마디를 남깁니다. (30자 제한)</li>
                <li>모든 발언을 듣고 난 후 라이어가 누구인지 토론합니다.</li>
                <li>라이어로 의심되는 사람에게 투표합니다.</li>
                <li>가장 많은 표를 받은 사람이 라이어인지 확인하기 위한 최종 투표를 진행합니다.</li>
                <li>최종 투표 합격 시, 라이어는 주제어를 맞혀야 승리할 수 있습니다.</li>
            </ol>
        </div>
        
        <div id="start-section" class="game-section">
        
            <div id="ranking-ui" style="text-align: center; margin-bottom: 20px;">
              <p id="streak-display"><strong>현재 연승: 0</strong></p>
              <button id="submit-ranking">🏆 랭킹 등록하기</button>
              <button id="view-ranking">📋 랭킹 확인하기</button>
            </div>
            <!-- 랭킹 결과 팝업 -->
            <div id="ranking-popup" class="hidden" style="
              position: fixed;
              top: 20%;
              left: 50%;
              transform: translate(-50%, 0);
              background-color: white;
              border: 2px solid #5c6bc0;
              border-radius: 10px;
              padding: 20px;
              width: 90%;
              max-width: 400px;
              box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
              z-index: 9999;
            ">
              <h3>🏆 전체 랭킹</h3>
              <ul id="ranking-list" style="padding-left: 20px; list-style: decimal;"></ul>
              <button onclick="document.getElementById('ranking-popup').classList.add('hidden')">닫기</button>
            </div>
            <h2>게임 시작</h2>
            <button id="start-game">게임 시작하기</button>
        </div>
        
        <div id="game-area" class="hidden">
            <div id="topic-info" class="topic-info"></div>
            
            <div id="statement-section" class="game-section hidden">
                <h2>주제어에 대한 한마디 작성</h2>
                <div id="players-statements"></div>
                <div id="statement-input" class="input-area">
                    <input type="text" id="statement" placeholder="주제어에 관한 한마디를 입력하세요 (30자 이내)" maxlength="30">
                    <button id="submit-statement">제출</button>
                </div>
            </div>
            
            <div id="discussion-section" class="game-section hidden">
                <h2>라이어 추리 토론</h2>
                <div id="discussion-statements"></div>
                <div id="discussion-input" class="input-area">
                    <input type="text" id="opinion" placeholder="의견을 입력하세요 (50자 이내)" maxlength="50">
                    <button id="submit-opinion">제출</button>
                </div>
            </div>
            <div id="vote-result-popup" class="hidden" style="
                position: fixed;
                top: 30%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 2px solid #3f51b5;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                text-align: center;
                z-index: 9999;
                font-size: 18px;
              ">
                <p id="vote-result-text"></p>
            </div>
            <div id="liar-found-popup" class="hidden" style="
              position: fixed;
              top: 30%;
              left: 50%;
              transform: translate(-50%, -50%);
              background: #e8f5e9;
              border: 2px solid #4caf50;
              border-radius: 10px;
              padding: 20px;
              box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
              text-align: center;
              z-index: 9999;
              font-size: 18px;
              color: #2e7d32;
            ">
              <p>🎉 라이어를 맞췄습니다!<br>이제 라이어가 주제어를 추론할 시간입니다.</p>
            </div>
                <div id="ai-vote-wait-popup" class="hidden" style="
                position: fixed;
                top: 30%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #fffde7;
                border: 2px solid #fbc02d;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                text-align: center;
                z-index: 9999;
                font-size: 18px;
                color: #f57f17;
              ">
                <p>🤖 AI들이 투표 중입니다... 잠시만 기다려주세요.</p>
           </div>
            <div id="vote-section" class="game-section hidden">
                <h2>라이어 투표</h2>
                <p>라이어라고 생각하는 플레이어를 선택하세요:</p>
                <div id="vote-options" class="vote-area"></div>
                <button id="submit-vote" class="disabled">투표 제출</button>
            </div>
            
            <div id="final-vote-section" class="game-section hidden">
                <h2>최종 투표</h2>
                <p id="most-voted-player"></p>
                <p>이 플레이어가 라이어가 맞습니까?</p>
                <button id="vote-yes">예</button>
                <button id="vote-no">아니오</button>
            </div>
            
            <div id="liar-guess-section" class="game-section hidden">
                <h2>라이어의 주제어 추론</h2>
                <p id="liar-message"></p>
                <div id="liar-input" class="input-area">
                    <input type="text" id="topic-guess" placeholder="주제어를 추론해보세요">
                    <button id="submit-guess">제출</button>
                </div>
            </div>
            
            <div id="result-section" class="game-section hidden">
                <h2>게임 결과</h2>
                <div id="final-result" class="final-result"></div>
                <div id="game-summary"></div>
                <button id="play-again">다시 하기</button>
            </div>
        </div>
    </div>

    <script>
        // 연승 관련 변수
        let winStreak = Number(localStorage.getItem("winStreak") || "0");

        const submittedRankings = JSON.parse(localStorage.getItem("submittedRankings") || "[]");

        // DOM 요소
        const streakDisplay = document.getElementById("streak-display");
        const submitRankingButton = document.getElementById("submit-ranking");
        const viewRankingButton = document.getElementById("view-ranking");

        // 연승 표시 및 버튼 제어
        function updateStreakUI() {
          streakDisplay.innerHTML = `<strong>현재 연승: ${winStreak}</strong>`;
        }
        updateStreakUI();

        // ✅ 게임 승리 시 연승 증가
        function incrementWinStreak() {
          winStreak++;
          localStorage.setItem("winStreak", winStreak.toString());
          updateStreakUI();
        }

        // ❌ 게임 패배 시 연승 리셋
        function resetWinStreak() {
          winStreak = 0;
          localStorage.setItem("winStreak", "0");
          updateStreakUI();
        }

        // ✅ 랭킹 등록
        submitRankingButton.addEventListener("click", async () => {
          if (winStreak < 3) {
            alert("⚠️ 3연승 이상만 등록할 수 있습니다!");
            return;
          }

          const name = prompt("닉네임을 입력해주세요:");
          if (!name) return;

          const key = `${name}-${winStreak}`;
          if (submittedRankings.includes(key)) {
            alert("⚠️ 이미 같은 연승으로 등록한 닉네임입니다!");
            return;
          }

          if (localStorage.getItem("rankingSubmitted") === "true") {
            alert("⚠️ 한 판 더 진행한 후에 다시 등록할 수 있습니다.");
            return;
          }

          try {
            const res = await fetch("https://liar-game-backend.onrender.com/ranking", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ name, winStreak })
            });

            if (res.ok) {
              alert("🎉 랭킹 등록 완료!");
              submittedRankings.push(key);
              localStorage.setItem("submittedRankings", JSON.stringify(submittedRankings));
              localStorage.setItem("rankingSubmitted", "true"); // 등록 완료 상태 표시
            } else {
              alert("❌ 등록 실패: 서버 오류");
            }
          } catch (err) {
            alert("❌ 등록 실패: 네트워크 오류", err);
          }
        });


        viewRankingButton.addEventListener("click", async () => {
          try {
            const res = await fetch("https://liar-game-backend.onrender.com/ranking");
            const rankings = await res.json();

            const list = document.getElementById("ranking-list");
            list.innerHTML = rankings
              .sort((a, b) => b.winStreak - a.winStreak)
              .map((entry, i) => `<li>${entry.name}: ${entry.winStreak}연승</li>`)
              .join("");

            document.getElementById("ranking-popup").classList.remove("hidden");
          } catch {
            alert("❌ 랭킹 불러오기 실패");
          }
        });

        // ✅ 게임 종료 시 예시: 결과 판별 후 연승 처리
        function handleGameResult(didWin) {
          if (didWin) incrementWinStreak();
          else resetWinStreak();
        }
        // 게임 상태 관리 
        const gameState = {
            players: [
                { id: 0, name: "김춘봉", isAI: false, tone: "" },
                { id: 1, name: "제임스", isAI: true, tone: "경박한 남자 고등학생 말투" },
                { id: 2, name: "마이클", isAI: true, tone: "진중한 40대 아재 말투" },
                { id: 3, name: "엘리스", isAI: true, tone: "까칠한 30대 여성 말투" },
                { id: 4, name: "유나", isAI: true, tone: "착한 20대 여성 말투" }
            ],
            lierId: null,
            topic: "",
            category: "",
            playerStatements: [],
            discussionRound: 0,
            playerOpinions: [],
            currentVotes: {},
            mostVotedPlayer: null,
            mostVotedCount: 0,
            finalVoteResult: null,
            gameStage: "start",
            playerOrder: [],
            currentPlayerIndex: 0,
            statementsInfo: "",
            opinionsInfo: "",
            finalVoteFailedOnce : false,
        }; 

        // 주제와 카테고리
const topics = {
  "과일": [
    "사과", "바나나", "딸기", "수박", "포도", "키위", "망고", "파인애플", "오렌지",
    "복숭아", "자두", "귤", "레몬", "체리", "블루베리", "라임", "멜론", "자몽", "무화과",
    "용과", "천혜향", "홍시", "석류", "참외", "구아바", "아보카도", "코코넛"
  ],
  "동물": [
    "사자", "코끼리", "기린", "팬더", "호랑이", "강아지", "고양이", "원숭이", "토끼",
    "돌고래", "하마", "수달", "늑대", "참새", "고래", "양", "펭귄", "곰", "거북이",
    "말", "낙타", "다람쥐", "도마뱀", "앵무새", "뱀", "코알라", "캥거루"
  ],
  "직업": [
    "의사", "선생님", "경찰", "소방관", "프로그래머", "요리사", "디자이너", "변호사", "간호사",
    "배우", "가수", "운동선수", "파일럿", "판사", "작가", "농부", "건축가", "감독", "사서",
    "운전기사", "마술사", "사진작가", "통역사", "바리스타", "연구원", "환경미화원"
  ],
  "나라": [
    "한국", "미국", "일본", "중국", "프랑스", "영국", "독일", "이탈리아", "호주",
    "브라질", "인도", "이집트", "멕시코", "스페인", "러시아", "터키", "캐나다", "뉴질랜드",
    "노르웨이", "핀란드", "스웨덴", "네덜란드", "그리스", "체코", "폴란드", "베트남", "싱가포르"
  ],
  "음식": [
    "김치찌개", "피자", "파스타", "초밥", "햄버거", "비빔밥", "짜장면", "카레", "스테이크",
    "샐러드", "라면", "떡볶이", "닭갈비", "쌀국수", "타코", "우동", "샌드위치", "불고기",
    "된장국", "순두부찌개", "부대찌개", "냉면", "제육볶음", "감자탕", "치킨", "파전", "팟타이"
  ],
  "사물": [
    "청소기", "선풍기", "가습기", "커피머신", "믹서기", "토스터기", "전기밥솥", "전자시계", "헤어드라이어",
    "거울", "의자", "책상", "컵", "전화기", "리모컨", "스피커", "시계", "칫솔", "전구", "냉장고",
    "세탁기", "노트북", "마우스", "키보드", "프린터", "모니터", "텀블러", "전자렌지", "게임기", "선반"
  ],
    "교통수단": [
        "자동차", "지하철", "버스", "비행기", "기차", "자전거", "킥보드", "배", "택시", "헬리콥터",
        "스쿠터", "트럭", "요트", "유람선", "트램", "전동휠", "전기차", "고속열차", "비행선", "우주선", "경비행기"
    ],
  "스포츠": [
  "축구", "야구", "농구", "배구", "테니스", "탁구", "스키", "스노보드", "골프",
  "씨름", "양궁", "수영", "복싱", "럭비", "핸드볼", "하키", "체조", "육상", "스케이트",
  "사이클", "클라이밍"
],
  "장소": [
  "학교", "도서관", "병원", "식당", "카페", "지하철역", "공원", "놀이공원", "영화관", "편의점",
  "백화점", "마트", "헬스장", "체육관", "해변", "산", "놀이방", "버스터미널", "공항", "호텔",
  "미술관", "박물관", "수영장", "서점", "공장", "카지노"
], 
   "영화 이름": ["타이타닉", "어벤져스", "인셉션", "반지의 제왕", "인터스텔라", "아바타", "매트릭스", "조커"],
  "세계 명소": ["에펠탑", "자유의 여신상", "피라미드", "만리장성", "콜로세움", "타지마할", "마추픽추", "시드니 오페라하우스", "그랜드캐니언"]
};


        // UI 요소 참조
        const startSection = document.getElementById("start-section");
        const gameArea = document.getElementById("game-area");
        const topicInfo = document.getElementById("topic-info");
        const statementSection = document.getElementById("statement-section");
        const playersStatements = document.getElementById("players-statements");
        const statementInput = document.getElementById("statement");
        const submitStatement = document.getElementById("submit-statement");
        const discussionSection = document.getElementById("discussion-section");
        const discussionStatements = document.getElementById("discussion-statements");
        const opinionInput = document.getElementById("opinion");
        const submitOpinion = document.getElementById("submit-opinion");
        const voteSection = document.getElementById("vote-section");
        const voteOptions = document.getElementById("vote-options");
        const submitVote = document.getElementById("submit-vote");
        const finalVoteSection = document.getElementById("final-vote-section");
        const mostVotedPlayerElement = document.getElementById("most-voted-player");
        const voteYes = document.getElementById("vote-yes");
        const voteNo = document.getElementById("vote-no");
        const liarGuessSection = document.getElementById("liar-guess-section");
        const liarMessage = document.getElementById("liar-message");
        const topicGuess = document.getElementById("topic-guess");
        const submitGuess = document.getElementById("submit-guess");
        const resultSection = document.getElementById("result-section");
        const finalResult = document.getElementById("final-result");
        const gameSummary = document.getElementById("game-summary");
        const playAgain = document.getElementById("play-again");

        // 게임 시작 버튼 이벤트 리스너
        document.getElementById("start-game").addEventListener("click", function() {
            console.log("Start game button clicked");
            startGame();
        });
      
        statementInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
              e.preventDefault();
              submitStatement.click();
          }
        });
      
        opinionInput.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                submitOpinion.click();
            }
        });
          topicGuess.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                submitGuess.click();
            }
        });


        // 게임 시작 함수
        function startGame() {
            // 게임 상태 초기화
            console.log("Starting game...");
            resetGameState();
            
            // 라이어 지정 (0-3 중 랜덤)
            gameState.lierId = Math.floor(Math.random() * 5);
            
            // 카테고리 및 주제어 선정
            const categories = Object.keys(topics);
            gameState.category = categories[Math.floor(Math.random() * categories.length)];
            const topicList = topics[gameState.category];
            gameState.topic = topicList[Math.floor(Math.random() * topicList.length)];
            
            // 플레이어 순서 랜덤 지정 
            gameState.playerOrder = [0, 1, 2, 3, 4].sort(() => Math.random() - 0.5);
            
            // UI 업데이트
            startSection.classList.add("hidden");
            gameArea.classList.remove("hidden");
            
            // 주제 정보 표시
            if (gameState.lierId === 0) {
                // 플레이어가 라이어인 경우
                topicInfo.innerHTML = `<p>당신은 <strong>라이어</strong>입니다!</p>
                                     <p>카테고리: <strong>${gameState.category}</strong></p>
                                     <p>주제어는 알 수 없지만, 다른 사람들의 발언을 듣고 추측해보세요.</p>`;
            } else {
                // 플레이어가 시민인 경우
                topicInfo.innerHTML = `<p>당신은 <strong>시민</strong>입니다!</p>
                                     <p>카테고리: <strong>${gameState.category}</strong></p>
                                     <p>주제어: <strong>${gameState.topic}</strong></p>`;
            }
            
            // 한마디 작성 단계 시작
            startStatementPhase();
        }

        // 게임 상태 초기화
        function resetGameState() {
            gameState.lierId = null;
            gameState.topic = "";
            gameState.category = "";
            gameState.playerStatements = [];
            gameState.discussionRound = 0;
            gameState.playerOpinions = [];
            gameState.currentVotes = {};
            gameState.mostVotedPlayer = null;
            gameState.finalVoteResult = null;
            gameState.gameStage = "start";
            gameState.playerOrder = [];
            gameState.currentPlayerIndex = 0;
            gameState.finalVoteFailedOnce = false;
        }

        // 한마디 작성 단계 시작
        function startStatementPhase() {
            gameState.gameStage = "statement";
            statementSection.classList.remove("hidden");
            playersStatements.innerHTML = "";

            // UI 준비
            for (const playerId of gameState.playerOrder) {
                const player = gameState.players.find(p => p.id === playerId);
                const playerElement = document.createElement("div");
                playerElement.className = `player ${player.id === 0 ? "you" : ""}`;
                playerElement.id = `player-statement-${player.id}`;
                playerElement.innerHTML = `<p>${player.name}</p>
                                           <p class="statement" id="statement-${player.id}">...</p>`;
                playersStatements.appendChild(playerElement);
            }

            // 순서대로 발언 시작
            gameState.currentPlayerIndex = 0;
            handleNextStatement();
        }
      
        async function handleNextStatement() {
            // 순서 끝났으면 다음 단계로
            if (gameState.currentPlayerIndex >= gameState.playerOrder.length) {
                // 한마디 섹션 숨기고 → 추리 단계로
                statementSection.classList.add("hidden");
                startDiscussionPhase();
                return;
            }

            const currentId = gameState.playerOrder[gameState.currentPlayerIndex];
            const player = gameState.players.find(p => p.id === currentId);

            if (player.id === 0) {
                // 플레이어 차례
                statementInput.value = "";
                statementInput.disabled = false;
                submitStatement.disabled = false;
                statementInput.focus();
            } else {
              
              
              const indexInOrder = gameState.playerOrder.indexOf(player.id);

              let previousStatements = "";

              if (indexInOrder > 0) {
                  previousStatements = gameState.playerOrder
                      .slice(0, indexInOrder)
                      .map(id => {
                          const p = gameState.players.find(p => p.id === id);
                          const s = gameState.playerStatements[id];
                          return s ? `${p.name}: "${s}"` : null;
                      })
                      .filter(Boolean)
                      .join("\n");
              }

                // AI 플레이어 응답 생성
              const aiPrompt = `당신은 라이어 게임을 하고 있습니다.

              ${
                player.id === gameState.lierId
                  ? `당신은 **라이어**입니다.  
              당신의 이름은 '${player.name}'이고 말투는 '${player.tone}'입니다.  
              카테고리는 '${gameState.category}'입니다.  
              주제어에 대한 힌트를 30자 이내로 작성해주세요. 당신은 주제어를 모르므로, 들키지 않도록 신중하게 작성해야 합니다.

              📌 주의사항:
              1. 주제어가 발언에 포함되면 절대로 안 됩니다.  
              2. 발언만 보고 주제어를 유추할 수 있을 정도의 힌트는 금지입니다.  
              3. **미사여구, 장황한 표현, 게임과 무관한 멘트, 본인 이름 언급** 모두 금지입니다.

              지금까지의 다른 플레이어 발언:
              ${previousStatements || "(없음)"}

              이 발언들을 참고해 흐름에 맞춰 말해주세요.`
                  : `당신은 **시민**입니다.  
              카테고리는 '${gameState.category}'이고, 주제어는 '${gameState.topic}'입니다.  
              당신의 이름은 '${player.name}'이고 말투는 '${player.tone}'입니다.  
              주제어에 대한 힌트를 30자 이내로 작성해주세요.

              📌 주의사항:
              1. 주제어가 발언에 포함되면 절대로 안 됩니다.  
              2. 직접적인 힌트는 라이어에게 너무 유리해질 수 있으므로, 반드시 최소한의 힌트로 본인이 라이어가 아님을 입증할 수 있는 애매모호한 힌트를 제공하세요.
              3. 발언만 보고 주제어를 유추할 수 있을 정도의 힌트는 금지입니다.  
              4. **미사여구, 장황한 표현, 게임과 무관한 멘트, 본인 이름 언급** 모두 금지입니다.

              지금까지의 다른 플레이어 발언:
              ${previousStatements || "(없음)"}`
              }
              `;
                const aiResponse = await getAIResponse(player, aiPrompt, 70);
                gameState.playerStatements[player.id] = aiResponse;
                document.getElementById(`statement-${player.id}`).textContent = aiResponse;
                //console.log(`한마디 프롬프트: ${aiPrompt}`);
                // 다음 사람 차례
                gameState.currentPlayerIndex++;
                setTimeout(() => {
                    handleNextStatement();
                }, 1000);
            }
        }
     /*
        // AI 플레이어 발언 처리
        async function processAIStatements() {
            for (const playerId of gameState.playerOrder) {
                const player = gameState.players.find(p => p.id === playerId);
                
                if (player.id === 0) {
                    // 플레이어 차례이면 입력 UI 활성화
                    statementInput.value = "";
                    statementInput.focus();
                    continue;
                }
              const previousStatements = gameState.playerOrder
              .slice(0, gameState.playerOrder.indexOf(playerId))
              .map(id => {
                  const p = gameState.players.find(p => p.id === id);
                  const s = gameState.playerStatements[id];
                  return s ? `${p.name}: "${s}"` : null;
              })
              .filter(Boolean)
              .join("\n");
                
                // AI 플레이어 응답 생성
                const aiPrompt = `당신은 라이어 게임을 하고 있습니다. ${player.id === gameState.lierId ? 
                    `당신은 라이어입니다. 당신의 이름은 '${player.name}'이고 당신의 말투는 '${player.tone}'을 지켜서 말해주세요. 카테고리는 '${gameState.category}'입니다. 주제어에 대한 힌트를 30자 이내로 작성해주세요. 당신은 라이어이고 주제어를 모르기 때문에 들키지 않도록 잘 답변하세요. 발언에 본인 이름과 같이 게임과 관련없는 말은 일체 금지. 지금까지의 다른 플레이어 발언: ${previousStatements || "(없음)"}` : 
                    `당신은 시민입니다. 주제어는 '${gameState.topic}'입니다.`} 당신의 이름은 '${player.name}'이고 당신의 말투는 '${player.tone}'을 지켜서 말해주세요. 주제어에 대한 힌트를 30자 이내로 작성해주세요. 주제어가 한마디안에 포함되면 절대로 안되며, 너무 직접적인 힌트는 라이어에게 너무 유리해질 수 있으므로 간접적이고 모호하도록 힌트를 주세요. 발언에 본인 이름과 같이 게임과 관련없는 말은 일체 금지. 지금까지의 다른 플레이어 발언: ${previousStatements || "(없음)"}`;
                console.log("프롬프트", aiPrompt); 
                const aiResponse = await getAIResponse(player, aiPrompt, 70);
                
                // 발언 저장 및 UI 업데이트
                gameState.playerStatements[player.id] = aiResponse;
                document.getElementById(`statement-${player.id}`).textContent = aiResponse;
                
                // 짧은 딜레이 (UI 효과)
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
      */

        // 플레이어 발언 제출
        submitStatement.addEventListener("click", function () {
            const statement = statementInput.value.trim();
            if (statement === "") {
                alert("한마디를 입력해주세요.");
                return;
            }

            gameState.playerStatements[0] = statement;
            document.getElementById("statement-0").textContent = statement;

            // 입력창 비활성화
            statementInput.disabled = true;
            submitStatement.disabled = true;

            // 다음 사람 차례로
            gameState.currentPlayerIndex++;
            setTimeout(() => {
                handleNextStatement();
            }, 500);
        });

        // 토론 단계 시작
        function startDiscussionPhase() {
            discussionStatements.innerHTML = `
              <h3>플레이어들의 한마디</h3>
              ${gameState.playerOrder.map(id => {
                  const player = gameState.players.find(p => p.id === id);
                  const statement = gameState.playerStatements[id];
                  return `<div class="message"><strong>${player.name}:</strong> ${statement}</div>`;
              }).join('')}
              <hr>
              <p><strong>이제 라이어가 누구인지 추리해봅시다:</strong></p>
            `;
            gameState.gameStage = "discussion";
            gameState.discussionRound++;
            gameState.currentPlayerIndex = 0;
            gameState.playerOpinions = [];
            
            discussionSection.classList.remove("hidden");
            
            // 플레이어 순서대로 의견 발표
            processAIOpinions();
        }

        // AI 의견 처리
        async function processAIOpinions() {
            for (const playerId of gameState.playerOrder) {
                const player = gameState.players.find(p => p.id === playerId);
                
                if (player.id === 0) {
                    // 플레이어 차례이면 입력 UI 활성화
                    opinionInput.value = "";
                    opinionInput.focus();
                    continue;
                }
                
                // AI 플레이어 응답 생성
                const statementsInfo = gameState.playerOrder.map(id => {
                    const player = gameState.players.find(p => p.id === id);
                    const statement = gameState.playerStatements[id] || "(아직 발언 없음)";
                    return `${player.name}: "${statement}"`;
                }).join("\n");
                
                
              
                const aiPrompt = `
                당신은 라이어 게임에 참가 중인 AI 플레이어입니다. 당신의 이름은 '${player.name}'이고 당신의 말투는 '${player.tone}'입니다.

                ${player.id !== gameState.lierId ? 
                    `당신은 시민이며, 카테고리: '${gameState.category}'이고 주제어는 '${gameState.topic}'입니다.` :
                    `당신은 라이어이며, 주제어는 알 수 없습니다. 카테고리: '${gameState.category}'만 알고 있습니다.`}
 
                모든 플레이어의 발언은 다음과 같습니다:
                ${statementsInfo}

                라이어가 누구라고 생각하는지 30자 이내로 간단히 설명해주세요. 판단의 근거는 다음을 따르세요. 
                1. 참가자들의 힌트를 하나씩 보면서 주제어랑 관련이 있고, 맞는 말인지 판단하세요. 가장 관련이 적고 어긋난 사람이 라이어입니다.
                2. 모두가 정확히 맞는 말을 했다면 힌트가 너무 포괄적인가? 그렇다면 라이어입니다.

                두 문장 이내로 작성해주세요. 발언에는 "절대로 주제어가 포함되어서는 안됩니다." 답변은 '이름, 이유'순으로 답변할 것.절대 '${player.name}'을 지목해서는 안됩니다. 답변에 '${player.name}'가 절대 들어가면 안됨. 
                `;
                const aiOpinion = await getAIResponse(player, aiPrompt, 100);
                
                // 의견 저장 및 UI 업데이트
                gameState.playerOpinions[player.id] = aiOpinion;
                const opinionElement = document.createElement("div");
                opinionElement.className = "message";
                opinionElement.innerHTML = `<strong>${player.name}:</strong> ${aiOpinion}`;
                discussionStatements.appendChild(opinionElement);
                
                // 짧은 딜레이 (UI 효과)
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        // 플레이어 의견 제출
        submitOpinion.addEventListener("click", function() {
            const opinion = opinionInput.value.trim();
            
            if (opinion === "") {
                alert("의견을 입력해주세요.");
                return; 
            }
            
            // 의견 저장 및 UI 업데이트
            gameState.playerOpinions[0] = opinion;
            const opinionElement = document.createElement("div");
            opinionElement.className = "message";
            opinionElement.innerHTML = `<strong>${gameState.players[0].name}:</strong> ${opinion}`;
            discussionStatements.appendChild(opinionElement);
            
            // 다음 단계로 진행
            setTimeout(() => {
                discussionSection.classList.add("hidden");
                startVotePhase();
            }, 1000);
        });
        
    function waitForAIVotesOrTimeout() {
      return Promise.race([
        processAIVotes(),          // AI 투표 완료까지 대기
        new Promise(resolve => setTimeout(resolve, 7000)) // 7초 후에도 계속 진행
      ]);
    }
        // 투표 단계 시작
function startVotePhase() {
    gameState.gameStage = "vote";
    gameState.currentVotes = {};

    // 처음엔 투표창 숨기기
    voteSection.classList.add("hidden");

    // 플레이어 요약 초기화 및 표시 준비
    const summaryDiv = document.createElement("div");
    summaryDiv.innerHTML = `
      <h3>플레이어 요약</h3>
      ${gameState.playerOrder.map(id => { 
          const player = gameState.players.find(p => p.id === id);
          const statement = gameState.playerStatements[id] || "(발언 없음)";
          const opinion = gameState.playerOpinions[id] || "(의견 없음)";
          return `<div class="message">
                    <strong>${player.name}</strong><br>
                    🗣️ 한마디: ${statement}<br>
                    💬 의견: ${opinion}
                  </div>`;
      }).join('')}
      <hr>
    `;

    voteSection.insertBefore(summaryDiv, voteOptions);
    voteOptions.innerHTML = "";


    // 실행 코드
    document.getElementById("ai-vote-wait-popup").classList.remove("hidden");

    waitForAIVotesOrTimeout().then(() => {
      document.getElementById("ai-vote-wait-popup").classList.add("hidden");

        voteSection.classList.remove("hidden");
    
        // 투표 옵션 생성
        gameState.players.forEach(player => {
          const voteOption = document.createElement("div");
          voteOption.className = "vote-player";
          voteOption.id = `vote-option-${player.id}`;
          voteOption.innerHTML = `<p>${player.name}</p>`;
          voteOption.addEventListener("click", function () {
            document.querySelectorAll(".vote-player").forEach(el => el.classList.remove("selected"));
            this.classList.add("selected");
            submitVote.classList.remove("disabled");
          });
          voteOptions.appendChild(voteOption);
        });
      });

}
      
      function renderVoteOptions() {
            voteOptions.innerHTML = ""; // 기존 "AI 투표 중" 문구 제거

            gameState.players.forEach(player => {
                const voteOption = document.createElement("div");
                voteOption.className = "vote-player";
                voteOption.id = `vote-option-${player.id}`;
                voteOption.innerHTML = `<p>${player.name}</p>`;
                voteOption.addEventListener("click", function () {
                    // 이전 선택 초기화
                    document.querySelectorAll(".vote-player").forEach(el => el.classList.remove("selected"));
                    this.classList.add("selected");

                    // 버튼 활성화
                    submitVote.classList.remove("disabled");
                });
                voteOptions.appendChild(voteOption);
            });
        }
        // AI 투표 처리
        async function processAIVotes() {
            // 각 AI 플레이어 투표 처리
            for (let i = 1; i < 5; i++) {
                const aiPlayer = gameState.players.find(p => p.id === i);

                // 모든 플레이어의 발언 정보 수집
                const statementsInfo = gameState.playerOrder.map(id => {
                    const p = gameState.players.find(p => p.id === id);
                    return `${p.name}: "${gameState.playerStatements[p.id]}"`;
                }).join("\n");

                // 토론 의견도 수집
                const opinionsInfo = gameState.playerOrder
                    .filter(id => gameState.playerOpinions[id]) // undefined 제외
                    .map(id => {
                        const p = gameState.players.find(p => p.id === id);
                        return `${p.name}의 의견: "${gameState.playerOpinions[p.id]}"`;
                    }).join("\n");
                gameState.statementsInfo = statementsInfo;
                gameState.opinionsInfo = opinionsInfo;
                // API 호출용 프롬프트 구성
                const aiPrompt = `
                당신은 라이어 게임의 참가자이며, 당신의 이름은 '${aiPlayer.name}'입니다.
                ${i === gameState.lierId ? 
                    '당신은 라이어입니다. 자신의 정체를 숨기고 시민처럼 행동하세요.' : 
                    '당신은 시민입니다. 라이어를 정확히 찾아야 합니다.'}

        카테고리: '${gameState.category}'
        ${i !== gameState.lierId ? `주제어: '${gameState.topic}'` : ''}

        모든 플레이어의 발언:
        ${statementsInfo}

        토론 의견:
        ${opinionsInfo}

        누가 라이어인지 분석하고, 라이어라고 생각되는 플레이어 번호 하나만 답변해주세요. 자신'${aiPlayer.name}'은 투표할 수 없습니다. 0은 김춘봉, 1은 제임스, 2는 마이클, 3은 엘리스, 4는 유나입니다. 숫자만 답변해주세요.`;

                // API 호출
                const aiResponse = await getAIResponse(aiPlayer, aiPrompt, 5);
                // 응답에서 숫자만 추출
                const votedId = parseInt(aiResponse.match(/\d+/)?.[0]);

                // 유효한 투표인지 확인 (자신이 아니고, 0-3 사이)
                if (!isNaN(votedId) && votedId >= 0 && votedId <= 4 && votedId !== i) {
                    gameState.currentVotes[i] = votedId;
                } else {
                    // 유효하지 않은 응답인 경우 랜덤 투표 (자신 제외)
                    let randomVote;
                    do {
                        randomVote = Math.floor(Math.random() * 4);
                    } while (randomVote === i);

                    gameState.currentVotes[i] = randomVote;
                }

                console.log(`${aiPlayer.name}의 투표: ${gameState.currentVotes[i]}`);
            }
        }

        // 플레이어 투표 제출
        submitVote.addEventListener("click", function() {
            if (this.classList.contains("disabled")) {
                return;
            }
            
            // 선택된 플레이어 확인
            const selectedOption = document.querySelector(".vote-player.selected");
            if (!selectedOption) {
                alert("투표할 플레이어를 선택해주세요.");
                return;
            }
            
            const votedId = parseInt(selectedOption.id.split("-")[2]);
            gameState.currentVotes[0] = votedId;
            
            // 투표 결과 계산
            calculateVoteResults();
            

            // ✅ 투표 UI 숨김
            voteSection.classList.add("hidden");

            // ✅ 찬반투표 생략 로직
            if (gameState.finalVoteFailedOnce) {
                const votedPlayer = gameState.players.find(p => p.id === gameState.mostVotedPlayer);
                const liarIsCaught = gameState.mostVotedPlayer === gameState.lierId;

                // ✅ 투표 결과 팝업 표시
                const votePopup = document.getElementById("vote-result-popup");
                const voteText = document.getElementById("vote-result-text");
                voteText.innerHTML = `
                  🔁 재투표 결과<br>
                  최다 득표자: ${votedPlayer.name}<br>
                  득표 수: ${gameState.mostVotedCount}<br>
                  찬반 없이 바로 결과 처리됩니다.
                `;
                votePopup.classList.remove("hidden");

                setTimeout(() => {
                    votePopup.classList.add("hidden");
                    if (liarIsCaught) {
                        showLiarFoundPopup();
                    } else {
                        endGame("citizens");
                    }
                }, 3000);

                return; // ✅ 찬반투표 생략하고 종료
            }

            // ✅ 기본 루트 - 찬반 투표로 넘어감
            startFinalVotePhase();
        });

        // 투표 결과 계산
// 투표 결과 계산
function calculateVoteResults() {
    const voteCounts = [0, 0, 0, 0, 0];
    
    // 각 플레이어 투표 집계
    for (const [voterId, votedId] of Object.entries(gameState.currentVotes)) {
        voteCounts[votedId]++;
    }
    // 최다 득표자 찾기 (동점일 경우 랜덤 선택)
    const maxVotes = Math.max(...voteCounts);
    const maxVotedPlayers = [];
    
    for (let i = 0; i < voteCounts.length; i++) {
        if (voteCounts[i] === maxVotes) {
            maxVotedPlayers.push(i);
        }
    }
    
    // 최다 득표자가 여러 명이면 랜덤 선택
    gameState.mostVotedPlayer = maxVotedPlayers[Math.floor(Math.random() * maxVotedPlayers.length)];
    gameState.mostVotedCount = voteCounts[gameState.mostVotedPlayer];
}

// 최종 투표 단계 시작
function startFinalVotePhase() {
    gameState.gameStage = "finalVote";
    finalVoteSection.classList.remove("hidden");

    const mostVotedPlayer = gameState.players.find(p => p.id === gameState.mostVotedPlayer);
    mostVotedPlayerElement.textContent = `가장 많은 표를 받은 플레이어: ${mostVotedPlayer.name}`;
    mostVotedPlayerElement.innerHTML = `
    가장 많은 표를 받은 플레이어: <strong>${mostVotedPlayer.name}</strong><br>
    받은 표 수: <strong>${gameState.mostVotedCount}표</strong>
  `; 

    // ✅ 버튼 재활성화 (이전 부결 투표 이후)
    voteYes.disabled = false;
    voteNo.disabled = false;

    // ✅ 이전 팝업 숨기기
    document.getElementById("ai-vote-wait-popup").classList.add("hidden");

    // ✅ 찬반 투표 기록 초기화
    finalVoteResults = {};
  
      // ✅ 추가: 플레이어들의 첫마디 요약 표시
    const hintSummary = document.createElement("div");
    hintSummary.innerHTML = `
        <hr>
        <h3>플레이어 한마디 요약</h3>
        ${gameState.playerOrder.map(id => {
            const player = gameState.players.find(p => p.id === id);
            const statement = gameState.playerStatements[id] || "(발언 없음)";
            return `<div class="message">
                      <strong>${player.name}:</strong> 🗣️ ${statement}
                    </div>`;
        }).join("")}
    `;
    
    // 기존에 요약이 있었다면 제거
    const existingSummary = document.getElementById("final-hint-summary");
    if (existingSummary) existingSummary.remove();
    
    hintSummary.id = "final-hint-summary";
    finalVoteSection.appendChild(hintSummary);
}

let finalVoteResults = {}; // voterId: true/false

voteYes.addEventListener("click", function () {
    voteYes.disabled = true;
    voteNo.disabled = true;

    // ✅ AI 기다리는 팝업 표시
    document.getElementById("ai-vote-wait-popup").classList.remove("hidden");

    // ✅ 플레이어의 찬성 투표 저장
    finalVoteResults[0] = true;

    // ✅ AI 최종 투표 시작
    processAIFinalVotes();
});

voteNo.addEventListener("click", function () {
    voteYes.disabled = true;
    voteNo.disabled = true;

    // ✅ AI 기다리는 팝업 표시
    document.getElementById("ai-vote-wait-popup").classList.remove("hidden");

    // ✅ 플레이어의 반대 투표 저장
    finalVoteResults[0] = false;

    // ✅ AI 최종 투표 시작
    processAIFinalVotes();
});

async function processAIFinalVotes() {
    for (let i = 1; i <= 4; i++) {
        const ai = gameState.players[i];
        const isLiar = gameState.lierId === i;
        const mostVotedId = gameState.mostVotedPlayer;
        const votedTarget = gameState.players[mostVotedId];
        const aiPreviousVote = gameState.currentVotes[i]; // AI가 일반 투표에서 찍은 사람
        const votedLine = 
            aiPreviousVote === mostVotedId
            ? `👉 당신은 ${votedTarget.name}에게 투표한 상태입니다.`
            : `👉 당신은 원래 ${gameState.players[aiPreviousVote].name}에게 투표했지만,\n다수의 투표로 인해 ${votedTarget.name}이 최종 후보가 되었습니다.`;

        const prompt = `
        당신은 라이어 게임에 참가 중인 플레이어입니다.
        당신의 이름은 '${ai.name}'이고 당신의 말투는 '${ai.tone}'입니다.

        🗳️ 지금 당신은 <${votedTarget.name}> 이(가) 라이어인지 최종 판단하는 찬반 투표에 참여 중입니다.
        ${votedLine}

        ${ai.id !== gameState.lierId ? 
            `당신은 시민이며, 주제어는 '${gameState.topic}'입니다.
                    다음은 모든 플레이어의 발언 정보입니다:

        🗣️ 첫마디 (주제 힌트):
        ${gameState.statementsInfo}

        💬 의견 토론:
        ${gameState.opinionsInfo}

        📌 라이어는 카테고리만 알고, 주제어를 모릅니다.

        ⚖️ 판단 기준:
        - ${votedTarget.name}가 라이어라고 생각되면 "예"
        - ${votedTarget.name}가 시민 같다고 생각되면 "아니오"
        - 당신이 라이어이고 본인이 지목되었다면 "아니오"
        - 당신이 라이어이고 다른 사람이 지목되었다면 "예"
        - 투표 대상이 '${ai.name}'라면 반드시 "아니오"
        - 대상이 ${votedTarget.name}라면 웬만하면 "예"
 
        ✍️ 반드시 이유와 함께 "예" 또는 "아니오"로만 응답하세요. (짧은 이유는 허용)` 
        :
            `당신은 라이어이며, 주제어는 알 수 없습니다. 카테고리: '${gameState.category}'만 알고 있습니다. 만약 당신:'${ai.name}'이 투표 대상이라면 무조건 아니오를 고르고 다른 참가자라면 무조건 예를 고르세요!!
            반드시 "예" 또는 "아니오"로만 응답하세요. 
            `}


        `.trim();

        const reply = await getAIResponse(gameState.players[i], prompt, 50);
        const vote = reply.includes("예") ? true : false;
        finalVoteResults[i] = vote;
        // 약간의 딜레이 주기
        //await new Promise(resolve => setTimeout(resolve, 500));
        //console.log(`프롬프트: ${prompt}`);
        //console.log(`대답: ${reply}`);
    }

    // ✅ 팝업 닫기
    document.getElementById("ai-vote-wait-popup").classList.add("hidden");
 
    // ✅ 최종 평가
    evaluateFinalVote();
}

// 라이어의 주제어 추론 단계 시작
function startLiarGuessPhase() {
    gameState.gameStage = "liarGuess";
    liarGuessSection.classList.remove("hidden");
    
    // 라이어가 플레이어인 경우와 AI인 경우 분리  
    if (gameState.lierId === 0) {
        // 플레이어가 라이어인 경우
        liarMessage.textContent = "당신이 라이어입니다! 주제어를 추론해보세요.";
        topicGuess.value = "";
        topicGuess.focus(); 
    } else {
        // AI가 라이어인 경우
        const liar = gameState.players.find(p => p.id === gameState.lierId);
        liarMessage.textContent = `${liar.name}이(가) 라이어입니다! 주제어를 추론하고 있습니다...`;
        
        // AI 라이어의 추론 처리
        processAILiarGuess();
    }
}
      
function evaluateFinalVote() {
    finalVoteSection.classList.add("hidden");

    const yesVotes = Object.values(finalVoteResults).filter(v => v === true).length;
    const noVotes = Object.values(finalVoteResults).filter(v => v === false).length;

    // ✅ 최종 투표 결과 팝업에 표시
    const votePopup = document.getElementById("vote-result-popup");
    const voteText = document.getElementById("vote-result-text");

    voteText.innerHTML = `
      ✔️ 찬성(예): ${yesVotes}표<br>
      ❌ 반대(아니오): ${noVotes}표
    `;
    votePopup.classList.remove("hidden");

    // ✅ 3초 후 다음 단계로 진행
    setTimeout(() => {
        votePopup.classList.add("hidden");

        if (yesVotes >= 3) {
            if (gameState.mostVotedPlayer === gameState.lierId) {
                showLiarFoundPopup();
            } else {
                endGame("citizens");
            }
        } else {
            alert("과반수 찬성을 얻지 못했습니다. 토론으로 돌아갑니다. 다음 투표에는 찬반 투표를 진행하지 않습니다.");
            startDiscussionPhase();
            gameState.finalVoteFailedOnce = true;
        }

        finalVoteResults = {};
    }, 3000);
}

function showLiarFoundPopup() {
    const popup = document.getElementById("liar-found-popup");
    popup.classList.remove("hidden");

    setTimeout(() => {
        popup.classList.add("hidden");
        startLiarGuessPhase();
    }, 2500);
}
     
// AI 라이어의 주제어 추론 처리
async function processAILiarGuess() {
    const liar = gameState.players.find(p => p.id === gameState.lierId);
    
    // 다른 플레이어들의 발언 모음
    const statementsInfo = gameState.playerOrder.map(id => {
        const p = gameState.players.find(p => p.id === id);
        return `${p.name}: "${gameState.playerStatements[p.id]}"`;
    }).join("\n");
    
    const aiPrompt = `당신은 라이어 게임에서 라이어입니다. 카테고리는 '${gameState.category}'이고, 다른 플레이어들의 발언은 다음과 같습니다:\n${statementsInfo}\n\n주제어를 추론해보세요. 답변은 단어로만 답변하세요.`;
    
    
    const aiGuess = await getAIResponse(liar, aiPrompt, 30);
    
    // 추론 결과 표시 및 게임 종료
    liarMessage.textContent = `${liar.name}의 추론: "${aiGuess}"`;
    
    // 잠시 후 게임 결과 표시
    setTimeout(() => {
        liarGuessSection.classList.add("hidden");
        
        // 추론 성공 여부 확인
        if (aiGuess.toLowerCase().includes(gameState.topic.toLowerCase())) {
            endGame("liar", aiGuess);
        } else {
            endGame("citizens", aiGuess);
        }
    }, 3000);
}

// 플레이어 라이어의 주제어 추론 제출
submitGuess.addEventListener("click", function() {
    const guess = topicGuess.value.trim();
    
    if (guess === "") {
        alert("추론한 주제어를 입력해주세요.");
        return;
    }
    
    liarGuessSection.classList.add("hidden");
    
    // 추론 성공 여부 확인
    if (guess.toLowerCase() === gameState.topic.toLowerCase()) {
        endGame("liar", guess);
    } else {
        endGame("citizens", guess);
    }
});

// 게임 종료 및 결과 표시
function endGame(winner, guess) {
    gameState.gameStage = "result";
    resultSection.classList.remove("hidden");
		localStorage.setItem("rankingSubmitted", "false");
    const liar = gameState.players.find(p => p.id === gameState.lierId);
    const liarName = liar.name;
    const playerIsLiar = gameState.lierId === 0;
    const liarGuessedCorrectly = (guess || "").toLowerCase() === gameState.topic.toLowerCase();
    const liarWasCaught = gameState.mostVotedPlayer === gameState.lierId;

    let resultText = "";
    let resultClass = "";

    // === CASE 1: 플레이어가 라이어 ===
    if (playerIsLiar) {
        if (liarWasCaught) {
            if (liarGuessedCorrectly) {
                resultText = `🟢 당신은 라이어였고 정체가 들통났지만,\n정확히 주제어를 맞춰 **승리**했습니다!`;
                handleGameResult(true);
                resultClass = "win";
            } else {
                resultText = `🔴 당신은 라이어였고 정체가 들통났고,\n주제어도 맞추지 못했습니다. **패배**입니다.`;
                handleGameResult(false);
                resultClass = "lose";
            }
        } else {
            // 들통 안 남 = 시민들이 못 맞춤
            resultText = `🟢 당신은 라이어였고 시민들은 당신을 의심하지 않았습니다!\n\n**정체를 숨기고 성공적으로 승리했습니다!**`;
            handleGameResult(true);
            resultClass = "win";
        }
    }

    // === CASE 2: 플레이어가 시민 ===
    else {
        if (liarWasCaught) {
            if (liarGuessedCorrectly) {
                resultText = `🔴 시민들은 라이어 ${liarName}의 정체를 밝혀냈지만,\n그가 주제어를 맞춰 **라이어의 승리**로 끝났습니다.`;
                handleGameResult(false);
                resultClass = "lose";
            } else {
                resultText = `🟢 시민들은 라이어 ${liarName}의 정체를 밝혀냈고,\n그는 주제어를 맞추지 못했습니다.\n\n**시민의 승리입니다!**`;
                handleGameResult(true);
                resultClass = "win";
            }
        } else {
            // 시민들이 라이어를 못 맞춤
            resultText = `🔴 시민들은 라이어를 맞추지 못했습니다.\n\n${liarName}이(가) 정체를 숨기고 **승리**했습니다.`;
            handleGameResult(false);
            resultClass = "lose";
        }
    }

    // 결과 출력
    finalResult.textContent = resultText;
    finalResult.className = `final-result ${resultClass}`;
    
    
    // 결과 표시
    finalResult.textContent = resultText;
    finalResult.className = `final-result ${resultClass}`;
    
    // 게임 요약 정보
    gameSummary.innerHTML = `
        <p>카테고리: <strong>${gameState.category}</strong></p>
        <p>주제어: <strong>${gameState.topic}</strong></p>
        <p>라이어: <strong>${gameState.players.find(p => p.id === gameState.lierId).name}</strong></p>
        <p>라이어의 추론: <strong>${guess || "없음"}</strong></p>
        <h3>플레이어 발언:</h3>
    `;
    
    // 플레이어 발언 요약
    gameState.playerOrder.forEach(id => {
        const player = gameState.players.find(p => p.id === id);
        const statement = gameState.playerStatements[player.id];
        
        const playerSummary = document.createElement("div");
        playerSummary.className = "player";
        if (player.id === gameState.lierId) {
            playerSummary.classList.add("liar");
        }
        playerSummary.innerHTML = `<p><strong>${player.name}${player.id === gameState.lierId ? " (라이어)" : ""}</strong>: ${statement}</p>`;
        
        gameSummary.appendChild(playerSummary);
    });
}

// 다시 하기 버튼
playAgain.addEventListener("click", function () {
    // 결과 화면 숨기기
    resultSection.classList.add("hidden");
    startSection.classList.remove("hidden"); 
    gameArea.classList.add("hidden");
    document.getElementById("vote-result-popup").classList.add("hidden");
    document.getElementById("vote-result-text").innerHTML = "";
    voteYes.disabled = false;
    voteNo.disabled = false;
    document.getElementById("ai-vote-wait-popup").classList.add("hidden");
    // ✅ 결과 요약 등 동적으로 추가된 요소 제거
    const summary = document.getElementById("final-vote-summary");
    if (summary) summary.remove();

    const oldSummaries = document.querySelectorAll(".message");
    oldSummaries.forEach(el => el.remove());

    // ✅ 투표 요약, 선택 초기화
    voteOptions.innerHTML = "";
    gameSummary.innerHTML = "";
    finalResult.textContent = "";
    finalResult.className = "final-result";

    // ✅ 게임 상태 리셋
    resetGameState();
});

// ChatGPT API 연동 함수 (실제 구현)
async function getAIResponseWithAPI(aiPlayer, prompt, maxLength) {
    try {
        const response = await fetch('https://liar-game-backend.onrender.com/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ prompt })
        });

        const data = await response.json();
        let aiResponse = data.reply || "응답 없음";
        if (maxLength && aiResponse.length > maxLength) {
            aiResponse = aiResponse.substring(0, maxLength);
        }
        
        return aiResponse;
    } catch (error) {
        console.error('API 호출 오류:', error);
        return "AI 응답 오류 발생";
    }
}


async function getAIResponse(aiPlayer, prompt, maxLength) {
    return await getAIResponseWithAPI(aiPlayer, prompt, maxLength);
}

        </script>
</body>  
